<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reseller Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root{ --primary: #A67734; --bg: #F9F7F5; }
    body{font-family:'Inter', sans-serif;background:var(--bg);color:#333}
    .card{background:white;padding:15px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);transition:0.2s; border: 2px solid transparent;}
    .card.selected{border-color:#0ea5e9;box-shadow:0 0 15px rgba(14, 165, 233, 0.2);}
    .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: #e5e7eb; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg mt-10">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Jana Pautan Jualan</h2>
      
      <!-- INPUTS -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div><label class="block font-bold text-sm mb-1">No. WhatsApp</label><input type="tel" id="whatsappNumber" class="w-full p-3 border rounded-lg bg-gray-50"></div>
        <div><label class="block font-bold text-sm mb-1">Nama Brand</label><input type="text" id="brandName" class="w-full p-3 border rounded-lg bg-gray-50"></div>
      </div>

      <!-- PRODUCT GRID -->
      <h3 class="font-bold text-gray-700 mb-4">Pilih Produk & Tetapkan Harga</h3>
      <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 min-h-[200px]">
          <!-- Loader -->
          <div class="col-span-full text-center py-10 text-gray-400">Loading products from HQ...</div>
      </div>

      <button onclick="generateLink()" class="mt-8 bg-green-500 text-white font-bold p-3 w-full rounded-lg shadow-lg hover:bg-green-600">Jana Link</button>
      
      <div id="resultArea" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <input type="text" id="finalLink" readonly class="w-full bg-transparent text-sm mb-2 text-center">
        <div class="text-center"><button onclick="copyLink()" class="text-blue-600 font-bold underline">Copy Link</button></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.firebasestorage.app",
            messagingSenderId: "...",
            appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let PRODUCTS_DATA = [];

    // 1. FETCH PRODUCTS
    async function loadProducts() {
        const grid = document.getElementById('product-grid');
        try {
            const snap = await getDocs(collection(db, 'products'));
            PRODUCTS_DATA = [];
            grid.innerHTML = '';

            snap.forEach(doc => {
                const p = doc.data();
                p.id = doc.id; // Critical: Use Firestore ID
                PRODUCTS_DATA.push(p);

                const imgUrl = p.images && p.images[0] ? p.images[0] : 'https://placehold.co/100';
                
                grid.innerHTML += `
                    <div id="card_${p.id}" class="card">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="chk_${p.id}" value="${p.id}" onchange="toggleCard('${p.id}')" class="w-5 h-5">
                            <span class="text-xs font-bold text-gray-500">Pilih</span>
                        </div>
                        <img src="${imgUrl}" class="w-16 h-16 rounded-lg mx-auto mb-2 object-cover">
                        <h4 class="text-sm font-bold text-center leading-tight mb-2 h-10 overflow-hidden">${p.name}</h4>
                        <input type="number" id="price_${p.id}" value="${p.rrp}" class="w-full text-center border rounded p-1 font-bold text-gray-700">
                    </div>
                `;
            });
        } catch (e) {
            grid.innerHTML = `<p class="text-red-500 col-span-full text-center">Failed to load products. Check Config.</p>`;
        }
    }

    // 2. EXPOSE FUNCTIONS TO WINDOW (Module Scope Fix)
    window.toggleCard = (id) => {
        const el = document.getElementById(`card_${id}`);
        const chk = document.getElementById(`chk_${id}`);
        if(chk.checked) el.classList.add('selected'); else el.classList.remove('selected');
    };

    window.generateLink = () => {
        let wa = document.getElementById('whatsappNumber').value.replace(/[^0-9]/g, '');
        let brand = document.getElementById('brandName').value.trim();
        if(wa.startsWith('0')) wa = '60' + wa.substring(1);

        let p_ids = [], p_prices = [];
        PRODUCTS_DATA.forEach(p => {
            const chk = document.getElementById(`chk_${p.id}`);
            if(chk && chk.checked) {
                p_ids.push(p.id);
                p_prices.push(document.getElementById(`price_${p.id}`).value);
            }
        });

        if(p_ids.length === 0) return alert("Pilih produk dahulu.");

        const params = new URLSearchParams({ rs_wa: wa, rs_brand: brand, p_ids: p_ids.join(','), p_prices: p_prices.join(',') });
        const url = window.location.href.replace('RSDashboard.html', 'OrderNow.html') + '?' + params.toString();
        
        document.getElementById('resultArea').classList.remove('hidden');
        document.getElementById('finalLink').value = url;
    };

    window.copyLink = () => {
        const link = document.getElementById('finalLink');
        link.select();
        document.execCommand('copy');
        alert("Copied!");
    };

    loadProducts();
  </script>
</body>
</html>
