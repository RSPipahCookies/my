<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Shop Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 120px; }
    .step-badge { width: 24px; height: 24px; background: #0f172a; color: white; border-radius: 50%; display: grid; place-items: center; font-size: 12px; font-weight: bold; }
    .input-box { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; outline: none; font-size: 14px; }
    .input-box:focus { border-color: #A67734; ring: 2px solid #A67734; }
    .color-dot { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 1px #cbd5e1; transition: 0.2s; }
    .color-dot.active { transform: scale(1.1); box-shadow: 0 0 0 2px #0f172a; }
    
    /* Custom Checkbox Animation */
    .custom-check { transition: all 0.2s ease; }
    .peer:checked ~ .card-body .custom-check { background-color: #A67734; border-color: #A67734; color: white; }
    .peer:checked ~ .card-body { border-color: #A67734; background-color: #fffaf0; }
  </style>
</head>
<body>

  <div class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-30 px-4 py-3 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <a href="index.html" class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center text-slate-600"><i class="fa-solid fa-arrow-left text-sm"></i></a>
      <h1 class="font-bold text-slate-800">Shop Builder</h1>
    </div>
    <button onclick="clearData()" class="text-xs text-red-500 font-bold">Reset</button>
  </div>

  <div class="max-w-md mx-auto px-4 mt-6 space-y-8">
    
    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
        <div class="flex items-center gap-2 mb-4">
            <div class="step-badge">1</div>
            <span class="font-bold text-sm uppercase">Shop Branding</span>
        </div>
        
        <div class="space-y-4">
            <input type="tel" id="rs_wa" class="input-box" placeholder="WhatsApp Number" oninput="saveState()">
            <input type="text" id="rs_name" class="input-box" placeholder="Shop Name (e.g. Kedai Cookies Lisa)" oninput="saveState()">
            
            <div class="grid grid-cols-2 gap-3">
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-3 text-center cursor-pointer hover:bg-slate-50 transition" onclick="document.getElementById('file-logo').click()">
                    <input type="file" id="file-logo" class="hidden" accept="image/*" onchange="uploadImage(this, 'logo-preview', 'rs_logo')">
                    <input type="hidden" id="rs_logo">
                    <img id="logo-preview" class="w-10 h-10 mx-auto rounded-full object-cover mb-1 bg-slate-100 hidden">
                    <div id="logo-lbl" class="text-[10px] font-bold text-slate-400">
                        <i class="fa-solid fa-camera mb-1 text-base"></i><br>Upload Logo<br>(Square)
                    </div>
                </div>

                <div class="border-2 border-dashed border-slate-300 rounded-xl p-3 text-center cursor-pointer hover:bg-slate-50 transition" onclick="document.getElementById('file-banner').click()">
                    <input type="file" id="file-banner" class="hidden" accept="image/*" onchange="uploadImage(this, 'banner-preview', 'rs_banner')">
                    <input type="hidden" id="rs_banner">
                    <img id="banner-preview" class="w-10 h-16 mx-auto rounded object-cover mb-1 bg-slate-100 hidden">
                    <div id="banner-lbl" class="text-[10px] font-bold text-slate-400">
                        <i class="fa-solid fa-image mb-1 text-base"></i><br>Upload Hero<br>(Vertical)
                    </div>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-slate-400 mb-2 block">Theme Color</label>
                <div class="flex gap-3 overflow-x-auto pb-2" id="color-picker"></div>
                <input type="hidden" id="rs_color" value="#A67734">
            </div>
        </div>
    </div>

    <div>
        <div class="flex items-center justify-between mb-3 px-1">
            <div class="flex items-center gap-2">
                <div class="step-badge">2</div>
                <span class="font-bold text-sm uppercase">Select Products</span>
            </div>
            <button onclick="selectAll()" class="text-xs font-bold text-blue-600">Select All</button>
        </div>
        <div id="product-list" class="space-y-3">
             <div class="text-center py-10 text-slate-400">Loading products...</div>
        </div>
    </div>
  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-40 pb-8 safe-area-bottom">
      <button onclick="generateLink()" id="gen-btn" class="w-full bg-[#A67734] text-white font-bold text-lg py-3.5 rounded-xl shadow-xl flex items-center justify-center gap-2">
        <i class="fa-solid fa-share-nodes"></i> Share Shop Link
      </button>
  </div>

     <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1zNzsKmXXLVsOVGnVeGwlT_0uX3XqdO0",
      authDomain: "pipahcookies-order.firebaseapp.com",
      databaseURL: "https://pipahcookies-order-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pipahcookies-order",
      storageBucket: "pipahcookies-order.firebasestorage.app",
      messagingSenderId: "1038900448087",
      appId: "1:1038900448087:web:a46586f21e9ae989708c12"
    };

    // 1. Initialize Firebase
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // 2. Offline Persistence
    db.enablePersistence().catch((err) => {
        if (err.code == 'failed-precondition') console.log("Offline mode failed: Multiple tabs open");
        else if (err.code == 'unimplemented') console.log("Browser doesn't support offline storage");
    });

    const COLORS = [{h:'#A67734'}, {h:'#ec4899'}, {h:'#3b82f6'}, {h:'#10b981'}, {h:'#ef4444'}, {h:'#0f172a'}];

    function init() { renderColors(); loadState(); fetchProducts(); }

    function renderColors() {
        const c = document.getElementById('rs_color').value;
        document.getElementById('color-picker').innerHTML = COLORS.map(col => `<div class="color-dot ${col.h==c?'active':''}" style="background:${col.h}" onclick="setColor('${col.h}')"></div>`).join('');
        document.getElementById('gen-btn').style.background = c;
    }
    window.setColor = (hex) => { document.getElementById('rs_color').value = hex; renderColors(); saveState(); }

    function fetchProducts() {
        db.collection('products').where('available', '==', true).get().then(snap => {
            const list = document.getElementById('product-list'); 
            list.innerHTML = '';
            
            snap.forEach(doc => {
                const p = doc.data();
                const cost = p.priceTier2 || (p.priceTier1 * 0.8) || 0; 
                const retail = p.priceTier1 || p.price || 0;
                const fakePrice = (retail * 1.2).toFixed(2);
                
                list.innerHTML += `
                <label class="relative block cursor-pointer select-none group">
                    <input type="checkbox" id="chk-${doc.id}" class="peer sr-only" onchange="toggleItem('${doc.id}', ${cost})">
                    
                    <div class="card-body bg-white p-3 rounded-xl border border-slate-200 flex gap-3 items-start transition duration-200">
                        <div class="custom-check w-6 h-6 flex-shrink-0 mt-1 rounded border-2 border-slate-300 bg-white text-transparent grid place-items-center">
                            <i class="fa-solid fa-check text-xs"></i>
                        </div>
                        
                        <img src="${p.image}" class="w-16 h-16 rounded-lg bg-gray-100 object-cover border border-slate-100">
                        
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-sm text-slate-800 truncate">${p.name}</h3>
                            <p class="text-[10px] text-slate-400 mt-0.5">Cost: RM${cost.toFixed(2)}</p>
                            
                            <div class="flex items-center gap-2 mt-2 opacity-40 pointer-events-none transition" id="box-${doc.id}">
                                
                                <div class="flex-1">
                                    <label class="text-[9px] font-bold text-green-600 uppercase block mb-0.5">Promo Price</label>
                                    <div class="flex items-center border border-green-200 rounded bg-green-50 px-2 py-1">
                                        <span class="text-[10px] font-bold text-green-700 mr-1">RM</span>
                                        <input type="number" id="price-${doc.id}" value="${retail.toFixed(2)}" class="w-full bg-transparent font-bold text-sm text-green-800 outline-none p-0" onclick="event.preventDefault()" onkeyup="calc('${doc.id}', ${cost})">
                                    </div>
                                </div>

                                <div class="flex-1">
                                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-0.5 line-through decoration-red-500">Normal Price</label>
                                    <div class="flex items-center border border-slate-200 rounded bg-slate-50 px-2 py-1">
                                        <span class="text-[10px] font-bold text-slate-400 mr-1">RM</span>
                                        <input type="number" id="old-price-${doc.id}" value="${fakePrice}" class="w-full bg-transparent font-bold text-sm text-slate-500 outline-none p-0" onclick="event.preventDefault()">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-2 text-[9px] font-bold text-white bg-green-500 px-2 py-0.5 rounded inline-block hidden" id="profit-${doc.id}">
                                Profit: RM0.00
                            </div>

                        </div>
                    </div>
                </label>`;
            });
        });
    }

    window.toggleItem = (id, cost) => {
        const chk = document.getElementById(`chk-${id}`);
        const box = document.getElementById(`box-${id}`);
        const badge = document.getElementById(`profit-${id}`);
        if(chk.checked) { 
            box.classList.remove('opacity-40', 'pointer-events-none'); 
            badge.classList.remove('hidden'); 
        } else { 
            box.classList.add('opacity-40', 'pointer-events-none'); 
            badge.classList.add('hidden'); 
        }
        calc(id, cost);
    }

    window.calc = (id, cost) => {
        const val = parseFloat(document.getElementById(`price-${id}`).value) || 0;
        const profit = val - cost;
        document.getElementById(`profit-${id}`).innerText = `Profit: RM${profit.toFixed(2)}`;
    }

    window.selectAll = () => { document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(!c.checked) c.click(); }); }
    
    function saveState() {
        localStorage.setItem('rs_v3', JSON.stringify({
            wa: document.getElementById('rs_wa').value,
            name: document.getElementById('rs_name').value,
            color: document.getElementById('rs_color').value,
            logo: document.getElementById('rs_logo').value,
            banner: document.getElementById('rs_banner').value
        }));
    }

    function loadState() {
        const s = JSON.parse(localStorage.getItem('rs_v3')||'{}');
        if(s.wa) document.getElementById('rs_wa').value = s.wa;
        if(s.name) document.getElementById('rs_name').value = s.name;
        if(s.color) setColor(s.color);
        
        if(s.logo) {
            document.getElementById('rs_logo').value = s.logo;
            document.getElementById('logo-preview').src = s.logo;
            document.getElementById('logo-preview').classList.remove('hidden');
            document.getElementById('logo-lbl').classList.add('hidden');
        }
        if(s.banner) {
            document.getElementById('rs_banner').value = s.banner;
            document.getElementById('banner-preview').src = s.banner;
            document.getElementById('banner-preview').classList.remove('hidden');
            document.getElementById('banner-lbl').classList.add('hidden');
        }
    }

    window.clearData = () => { if(confirm("Reset Form?")) { localStorage.removeItem('rs_v3'); location.reload(); } }

    // --- IMGBB UPLOAD LOGIC ---
    const IMGBB_API_KEY = "0bc69af865e3b77504d6b3d2eb3a1d37";

    async function uploadImage(input, previewId, storageId) {
        const file = input.files[0];
        if(!file) return;

        const lbl = input.parentElement.querySelector('div[id$="-lbl"]');
        const originalText = lbl.innerHTML;
        lbl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

        try {
            const formData = new FormData();
            formData.append("image", file);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                const url = result.data.url;
                document.getElementById(storageId).value = url;
                const img = document.getElementById(previewId);
                img.src = url;
                img.classList.remove('hidden');
                lbl.classList.add('hidden'); 
                saveState();
            } else {
                throw new Error("ImgBB Error: " + (result.error ? result.error.message : "Unknown"));
            }

        } catch(e) {
            console.error(e);
            alert("Upload failed. Ensure image is JPG/PNG and < 32MB.");
            lbl.innerHTML = originalText;
        }
    }

    // --- NEW GENERATE LINK LOGIC (SHORT URL) ---
    window.generateLink = async () => {
        const wa = document.getElementById('rs_wa').value.replace(/[^0-9]/g, '');
        const name = document.getElementById('rs_name').value;
        const color = document.getElementById('rs_color').value;
        const logo = document.getElementById('rs_logo').value;
        const banner = document.getElementById('rs_banner').value;

        if(!wa || !name) return alert("Please complete Step 1 (WhatsApp & Name)");

        const items = [], prices = [], oldPrices = [];
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => {
            const id = c.id.replace('chk-','');
            items.push(id);
            prices.push(document.getElementById(`price-${id}`).value);
            oldPrices.push(document.getElementById(`old-price-${id}`).value);
        });

        if(!items.length) return alert("Please select at least 1 product");

        // UI: Loading State
        const btn = document.getElementById('gen-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Creating Link...';
        btn.disabled = true;

        try {
            // 1. Prepare Data
            const shopData = { 
                w: wa.startsWith('0') ? '60'+wa.slice(1) : wa, 
                n: name, 
                c: color, 
                l: logo, 
                b: banner, 
                i: items, 
                p: prices, 
                op: oldPrices,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() // Optional: Timestamp
            };

            // 2. Save to Firestore (Collection: 'shops')
            const docRef = await db.collection('shops').add(shopData);

            // 3. Generate Short URL using ID
            // NOTE: Ensure your OrderNow.html is updated to read '?id='
            const url = `${window.location.origin}${window.location.pathname.replace('RSDashboard.html','OrderNow.html')}?id=${docRef.id}`;
            
            // 4. Share or Copy
            if(navigator.share) {
                await navigator.share({title: name, url: url});
            } else {
                navigator.clipboard.writeText(url);
                alert("Short link copied to clipboard!");
            }

        } catch (error) {
            console.error("Error creating shop:", error);
            alert("Failed to create link. Please check your internet connection.");
        } finally {
            // Restore Button
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    init();
  </script>
     </body>
</html>
