<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>RS Shop Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; color: #334155; padding-bottom: 100px; }
    .section-title { font-size: 0.85rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #94A3B8; margin-bottom: 0.75rem; }
    .input-box { width: 100%; background: white; border: 1px solid #E2E8F0; padding: 12px; border-radius: 10px; font-weight: 600; outline: none; transition: 0.2s; }
    .input-box:focus { border-color: #A67734; ring: 2px solid #A67734; }
    .color-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; }
    .color-dot.active { border-color: white; box-shadow: 0 0 0 2px #333; transform: scale(1.1); }
  </style>
</head>
<body>

  <div class="bg-white border-b sticky top-0 z-30 px-4 py-3 flex justify-between items-center shadow-sm">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-[#A67734] rounded-lg flex items-center justify-center text-white font-bold">RS</div>
      <h1 class="font-bold text-gray-800">Shop Builder</h1>
    </div>
    <a href="index.html" class="text-xs font-bold bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full">Exit</a>
  </div>

  <div class="max-w-md mx-auto px-4 mt-6 space-y-8">

    <section>
      <p class="section-title">Step 1: Store Identity</p>
      <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-4">
        
        <div>
          <label class="text-xs font-bold text-gray-400">WhatsApp Number (Required)</label>
          <input type="tel" id="rs_wa" class="input-box" placeholder="e.g. 60123456789" oninput="saveState()">
        </div>

        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="text-xs font-bold text-gray-400">Shop Name</label>
                <input type="text" id="rs_name" class="input-box" placeholder="e.g. Kak Lisa Cookies" oninput="saveState()">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400">Slogan / Location</label>
                <input type="text" id="rs_tagline" class="input-box" placeholder="e.g. Agent Sah Ampang" oninput="saveState()">
            </div>
        </div>

        <div>
           <label class="text-xs font-bold text-gray-400 mb-2 block">Theme Color</label>
           <div class="flex gap-3" id="color-picker">
              </div>
           <input type="hidden" id="rs_color" value="#A67734">
        </div>

      </div>
    </section>

    <section>
        <p class="section-title">Step 2: Payment Instructions</p>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
            <label class="text-xs font-bold text-gray-400">Bank Details (Shown at Checkout)</label>
            <textarea id="rs_bank" rows="2" class="input-box text-sm font-normal" placeholder="e.g. Maybank 1122334455 (Siti Nurhaliza). Send resit selepas bayar." oninput="saveState()"></textarea>
        </div>
    </section>

    <section>
        <p class="section-title">Step 3: Manage Inventory</p>
        <div id="product-list" class="space-y-3">
            </div>
    </section>

  </div>

  <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-40">
    <div class="max-w-md mx-auto">
      <button onclick="generateLink()" class="w-full bg-slate-900 text-white font-bold text-lg py-3.5 rounded-xl shadow-lg hover:bg-slate-800 transition active:scale-95 flex items-center justify-center gap-2">
        <span>ðŸš€ Launch Shop Link</span>
      </button>
      <p id="toast" class="text-center text-xs font-bold text-green-600 mt-2 hidden">Link Copied to Clipboard!</p>
    </div>
  </div>

<script src="pipah-product-config.js"></script>
<script>
    const COLORS = [
        { hex: '#A67734', name: 'Gold' },
        { hex: '#EC4899', name: 'Pink' },
        { hex: '#3B82F6', name: 'Blue' },
        { hex: '#10B981', name: 'Green' },
        { hex: '#111827', name: 'Black' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        renderColors();
        renderProducts();
    });

    // --- RENDERERS ---
    function renderColors() {
        const container = document.getElementById('color-picker');
        const current = document.getElementById('rs_color').value;
        
        container.innerHTML = COLORS.map(c => `
            <div class="color-dot ${c.hex === current ? 'active' : ''}" 
                 style="background:${c.hex}" 
                 onclick="selectColor('${c.hex}')">
            </div>
        `).join('');
    }

    function renderProducts() {
        const list = document.getElementById('product-list');
        list.innerHTML = window.PRODUCTS_DATA.map(p => `
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3 items-center">
                <input type="checkbox" id="chk-${p.id}" class="w-5 h-5 accent-slate-900" onchange="togglePriceInput('${p.id}')">
                <img src="${p.img}" class="w-12 h-12 rounded bg-gray-100 object-cover">
                <div class="flex-1">
                    <h3 class="font-bold text-sm text-gray-800">${p.name}</h3>
                </div>
                <div class="flex items-center gap-1 opacity-50 pointer-events-none transition" id="price-box-${p.id}">
                    <span class="text-xs text-gray-400">RM</span>
                    <input type="number" id="price-${p.id}" value="${p.rrp.toFixed(2)}" class="w-16 border rounded p-1 text-center font-bold text-sm">
                </div>
            </div>
        `).join('');
        
        // Restore checked state logic handled in loadState usually, simplified here
    }

    // --- LOGIC ---
    window.selectColor = (hex) => {
        document.getElementById('rs_color').value = hex;
        renderColors();
        saveState();
    };

    window.togglePriceInput = (id) => {
        const chk = document.getElementById(`chk-${id}`);
        const box = document.getElementById(`price-box-${id}`);
        if(chk.checked) {
            box.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            box.classList.add('opacity-50', 'pointer-events-none');
        }
    };

    // --- SAVE/LOAD ---
    function saveState() {
        const state = {
            wa: document.getElementById('rs_wa').value,
            name: document.getElementById('rs_name').value,
            tagline: document.getElementById('rs_tagline').value,
            bank: document.getElementById('rs_bank').value,
            color: document.getElementById('rs_color').value
        };
        localStorage.setItem('rs_profile', JSON.stringify(state));
    }

    function loadState() {
        const raw = localStorage.getItem('rs_profile');
        if(raw) {
            const s = JSON.parse(raw);
            if(s.wa) document.getElementById('rs_wa').value = s.wa;
            if(s.name) document.getElementById('rs_name').value = s.name;
            if(s.tagline) document.getElementById('rs_tagline').value = s.tagline;
            if(s.bank) document.getElementById('rs_bank').value = s.bank;
            if(s.color) document.getElementById('rs_color').value = s.color;
        }
    }

    // --- GENERATE LINK ---
    window.generateLink = () => {
        const wa = document.getElementById('rs_wa').value.replace(/[^0-9]/g, '');
        if(!wa) return alert("Please enter WhatsApp number");

        // Collect Products
        const items = [];
        const prices = [];
        
        window.PRODUCTS_DATA.forEach(p => {
            const chk = document.getElementById(`chk-${p.id}`);
            if(chk.checked) {
                items.push(p.id);
                prices.push(document.getElementById(`price-${p.id}`).value);
            }
        });

        if(items.length === 0) return alert("Select at least 1 product");

        // Construct Payload
        const payload = {
            w: wa.startsWith('0') ? '60'+wa.substring(1) : wa, // Phone
            n: document.getElementById('rs_name').value.trim(), // Shop Name
            t: document.getElementById('rs_tagline').value.trim(), // Tagline
            b: document.getElementById('rs_bank').value.trim(), // Bank Info
            c: document.getElementById('rs_color').value, // Color
            i: items,
            p: prices
        };

        // Safer Base64 Encoding for Unicode (Emojis/Malay text)
        const jsonStr = JSON.stringify(payload);
        const encoded = btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g,
            function toSolidBytes(match, p1) {
                return String.fromCharCode('0x' + p1);
        }));

        const url = `${window.location.origin}${window.location.pathname.replace('RSDashboard.html','OrderNow.html')}?d=${encoded}`;
        
        navigator.clipboard.writeText(url);
        const toast = document.getElementById('toast');
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    };
</script>
</body>
</html>
