<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Order Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: sans-serif; background-color: #F9FAFB; padding-bottom: 120px; }
    .qty-btn { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
    .img-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; background: #eee; }
  </style>
</head>
<body>

<div class="max-w-md mx-auto px-4 pt-6">
  <div class="text-center mb-6">
    <h1 id="brandTitle" class="text-2xl font-extrabold text-[#A67734]">PIPAHCOOKIES</h1>
    <p class="text-sm text-gray-500">Borang Pesanan</p>
  </div>

  <form id="order-form">
    <div class="bg-white p-4 rounded-xl shadow-sm border mb-4 space-y-3">
        <input type="text" id="cName" class="w-full border p-3 rounded-lg" placeholder="Nama Penuh" required>
        <input type="tel" id="cPhone" class="w-full border p-3 rounded-lg" placeholder="No. WhatsApp" required>
        <textarea id="cAddr" class="w-full border p-3 rounded-lg" placeholder="Alamat" required></textarea>
    </div>

    <div id="product-list" class="space-y-3">
        <div class="text-center py-10 text-gray-400">Loading products...</div>
    </div>

    <!-- Footer -->
    <div class="sticky-footer flex justify-between items-center gap-4 max-w-md mx-auto">
      <div>
        <p class="text-xs text-gray-500">Total</p>
        <p id="grand-total" class="text-xl font-bold">RM 0.00</p>
      </div>
      <button type="submit" id="submitBtn" class="flex-1 bg-green-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg">
        Hantar WhatsApp
      </button>
    </div>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.firebasestorage.app",
            messagingSenderId: "...",
            appId: "..."
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Parse URL Params
  const params = new URLSearchParams(window.location.search);
  const p_ids = (params.get('p_ids') || '').split(',');
  const p_prices = (params.get('p_prices') || '').split(',');
  const rsBrand = params.get('rs_brand');
  const rsWa = params.get('rs_wa');

  if(rsBrand) document.getElementById('brandTitle').innerText = rsBrand;

  async function renderOrderForm() {
      const container = document.getElementById('product-list');
      container.innerHTML = '';
      
      let hasItems = false;

      // Fetch details for each ID in URL
      for (let i = 0; i < p_ids.length; i++) {
          const pid = p_ids[i];
          if(!pid) continue;

          try {
            const docRef = doc(db, "products", pid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                hasItems = true;
                const p = docSnap.data();
                const price = parseFloat(p_prices[i]);
                const img = p.images && p.images[0] ? p.images[0] : '';

                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl shadow-sm border flex items-center gap-3";
                div.innerHTML = `
                    <img src="${img}" class="img-thumb">
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800 text-sm">${p.name}</h3>
                        <p class="text-[#A67734] font-bold">RM ${price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" class="qty-btn bg-gray-100" onclick="updateQty('${pid}', -1)">-</button>
                        <span id="qty-${pid}" class="w-6 text-center font-bold" data-price="${price}" data-name="${p.name}">0</span>
                        <button type="button" class="qty-btn bg-green-100 text-green-700" onclick="updateQty('${pid}', 1)">+</button>
                    </div>
                `;
                container.appendChild(div);
            }
          } catch (e) { console.error("Err loading product", pid); }
      }

      if(!hasItems) container.innerHTML = `<div class="text-center p-4 bg-red-50 text-red-500">Invalid Link.</div>`;
  }

  // --- GLOBAL HELPERS ---
  window.updateQty = (id, delta) => {
      const el = document.getElementById(`qty-${id}`);
      let v = parseInt(el.innerText) + delta;
      if(v < 0) v = 0;
      el.innerText = v;
      
      let total = 0;
      document.querySelectorAll('[id^="qty-"]').forEach(item => {
          total += parseInt(item.innerText) * parseFloat(item.dataset.price);
      });
      document.getElementById('grand-total').innerText = `RM ${total.toFixed(2)}`;
  };

  // --- SUBMIT ---
  document.getElementById('order-form').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.innerText = "Processing..."; btn.disabled = true;

      const customer = {
          name: document.getElementById('cName').value,
          phone: document.getElementById('cPhone').value,
          addr: document.getElementById('cAddr').value
      };

      let items = [], total = 0;
      document.querySelectorAll('[id^="qty-"]').forEach(el => {
          const q = parseInt(el.innerText);
          if(q > 0) {
              const sub = q * parseFloat(el.dataset.price);
              items.push({ name: el.dataset.name, qty: q, sub: sub });
              total += sub;
          }
      });

      if(items.length === 0) { alert("Pilih produk."); btn.disabled = false; return; }

      // Save to DB
      await addDoc(collection(db, "orders"), {
          reseller_wa: rsWa, reseller_brand: rsBrand, customer, items, total,
          created_at: serverTimestamp(), date_str: new Date().toLocaleString()
      });

      // WhatsApp
      const txt = items.map(i => `\nüç™ ${i.name} x${i.qty} (RM${i.sub.toFixed(2)})`).join('');
      const msg = `*PESANAN BARU* üìù\nNama: ${customer.name}\nTel: ${customer.phone}\nAlamat: ${customer.addr}\n\n*ORDER:*${txt}\n\n*TOTAL: RM ${total.toFixed(2)}*`;
      window.location.href = `https://wa.me/${rsWa || '601123456789'}?text=${encodeURIComponent(msg)}`;
  };

  renderOrderForm();
</script>
</body>
</html>
