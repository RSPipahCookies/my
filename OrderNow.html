<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Order Cookies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 140px; -webkit-tap-highlight-color: transparent; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ea580c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .active-tab { background-color: #f97316; color: white; box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3); }
    .inactive-tab { background-color: transparent; color: #64748b; }
  </style>
</head>
<body class="select-none">

  <div id="loader" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="font-bold text-slate-400 text-sm animate-pulse">Loading Shop...</p>
  </div>

  <div class="relative w-full bg-slate-900 overflow-hidden shadow-2xl transition-all duration-500 theme-bg-dark" id="header-container" style="min-height: 280px; border-radius: 0 0 2.5rem 2.5rem;">
    <div id="header-bg" class="absolute inset-0 bg-cover bg-center transition-opacity duration-500" style="opacity: 0.4;"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

    <div class="absolute top-0 left-0 right-0 p-4 z-20 flex justify-between items-start">
        <div class="flex bg-black/30 backdrop-blur rounded-full p-1 border border-white/10">
            <button onclick="setLang('ms')" id="l-ms" class="px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold transition">MY</button>
            <button onclick="setLang('en')" id="l-en" class="px-3 py-1 text-white/70 rounded-full text-[10px] font-bold transition">EN</button>
        </div>
        <button onclick="shareShop()" class="w-9 h-9 bg-white/10 backdrop-blur rounded-full text-white flex items-center justify-center border border-white/20 active:scale-95 transition">
            <i class="fa-solid fa-share-nodes"></i>
        </button>
    </div>

    <div class="absolute bottom-0 left-0 right-0 p-6 text-white z-10 flex flex-col items-center text-center pb-12">
        <div class="relative">
            <img id="shop-logo" class="w-24 h-24 rounded-full border-4 border-white shadow-xl mb-3 object-cover hidden bg-white">
            <div class="absolute -bottom-1 -right-1 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full border-2 border-white theme-bg">
                <i class="fa-solid fa-check-circle"></i> VERIFIED
            </div>
        </div>
        
        <h1 id="shop-name" class="text-3xl font-extrabold leading-tight mb-1 text-shadow tracking-tight">...</h1>
        <div class="flex items-center gap-2 text-xs font-medium text-white/80 bg-white/10 px-3 py-1 rounded-full backdrop-blur-sm">
            <i class="fa-solid fa-star text-yellow-400"></i> 5.0 (120+ Reviews)
        </div>
    </div>
  </div>

  <div class="max-w-md mx-auto px-4 -mt-8 relative z-20 space-y-6">
    
    <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs font-bold py-2 px-4 rounded-xl shadow-lg flex items-center gap-2 theme-bg overflow-hidden">
        <i class="fa-solid fa-bullhorn animate-pulse"></i>
        <marquee id="shop-promo" scrollamount="5" data-i18n="promo_text">Selamat Datang! Dapatkan biskut homemade fresh dari oven sekarang.</marquee>
    </div>

    <div class="bg-white p-2 rounded-xl shadow-md border border-slate-100 flex items-center gap-3 sticky top-4 z-30 transition-shadow focus-within:shadow-xl">
        <i class="fa-solid fa-magnifying-glass text-slate-400 ml-2"></i>
        <input type="text" id="search-input" onkeyup="filterProducts()" class="flex-1 bg-transparent outline-none text-sm font-semibold text-slate-700 placeholder-slate-400 h-10" placeholder="Search cookies...">
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100">
        <div class="flex items-center gap-2 mb-4 border-b border-slate-50 pb-2">
            <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 grid place-items-center theme-icon-bg theme-text"><i class="fa-regular fa-user"></i></div>
            <h3 class="text-sm font-bold text-slate-700 uppercase" data-i18n="your_info">Maklumat Anda</h3>
        </div>
        
        <div class="flex p-1 bg-slate-100 rounded-xl mb-4" id="method-container">
            <button onclick="setMethod('delivery')" id="btn-delivery" class="flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 active-tab theme-bg">
                <i class="fa-solid fa-motorcycle"></i> <span data-i18n="m_delivery">Delivery</span>
            </button>
            <button onclick="setMethod('pickup')" id="btn-pickup" class="flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 inactive-tab">
                <i class="fa-solid fa-shop"></i> <span data-i18n="m_pickup">Self Pickup</span>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block" data-i18n="lbl_name">Nama</label>
                <input type="text" id="c_name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 ring-orange-500 transition theme-ring" placeholder="Nama Penuh">
            </div>
            
            <div id="delivery-input">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block" data-i18n="lbl_addr">Alamat</label>
                <textarea id="c_addr" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-medium outline-none focus:ring-2 ring-orange-500 transition theme-ring" placeholder="Alamat Penghantaran"></textarea>
            </div>

            <div id="pickup-input" class="hidden grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block" data-i18n="lbl_date">Tarikh</label>
                    <input type="date" id="c_date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs font-bold text-slate-800 outline-none focus:ring-2 ring-orange-500 transition theme-ring">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block" data-i18n="lbl_time">Masa</label>
                    <input type="time" id="c_time" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs font-bold text-slate-800 outline-none focus:ring-2 ring-orange-500 transition theme-ring">
                </div>
            </div>
        </div>
    </div>

    <div>
        <div class="flex justify-between items-end mb-3 px-1">
            <h3 class="font-bold text-slate-800 text-lg" data-i18n="menu">Menu Pilihan</h3>
            <span class="text-xs font-semibold text-slate-400" id="item-count">0 Items</span>
        </div>
        <div id="product-list" class="space-y-3 pb-10"></div>
    </div>
  </div>

  <div class="fixed bottom-0 left-0 right-0 z-40 bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] pb-6 pt-3 px-4 transition-transform duration-300 transform translate-y-full" id="cart-bar">
    <div class="max-w-md mx-auto flex items-center justify-between gap-3">
        <div class="flex flex-col flex-1" onclick="openCart()">
            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider" data-i18n="total">Jumlah Besar</span>
            <div class="flex items-baseline gap-1 cursor-pointer">
                <span class="text-2xl font-extrabold text-slate-800" id="grand-total">RM 0.00</span>
                <span class="text-xs text-slate-400 font-medium" id="total-qty">(0 items)</span>
                <i class="fa-solid fa-chevron-up text-xs text-slate-300 ml-1"></i>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="openCart()" class="w-12 h-12 rounded-full border border-slate-200 bg-white text-slate-600 flex items-center justify-center shadow-sm active:scale-90 transition relative">
                <i class="fa-solid fa-list-check text-lg"></i>
            </button>
            <button onclick="submitOrder()" class="bg-green-500 hover:brightness-110 text-white font-bold h-12 px-6 rounded-full transition flex items-center gap-2 shadow-lg shadow-green-500/30 active:scale-95 theme-bg">
                <span data-i18n="btn_order">Checkout</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>
  </div>

  <div id="modal-backdrop" class="fixed inset-0 bg-black/60 z-[70] hidden transition-opacity duration-300 opacity-0 backdrop-blur-sm" onclick="closeModal(); closeCart();"></div>
  
  <div id="product-modal" class="fixed bottom-0 left-0 right-0 z-[80] bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 max-h-[85vh] overflow-y-auto hidden">
      <div class="relative">
          <button onclick="closeModal()" class="absolute top-4 right-4 z-10 w-8 h-8 bg-black/20 text-white rounded-full flex items-center justify-center backdrop-blur"><i class="fa-solid fa-xmark"></i></button>
          <img id="m-img" class="w-full h-64 object-cover">
          <div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-white to-transparent"></div>
      </div>
      <div class="p-6">
          <div class="flex justify-between items-start mb-2">
            <h2 id="m-name" class="text-2xl font-bold text-slate-900 leading-tight w-3/4">Product Name</h2>
            <div class="text-right">
                <p id="m-price" class="text-xl font-extrabold text-orange-600 theme-text">RM 0.00</p>
                <p id="m-old-price" class="text-sm text-slate-400 line-through hidden">RM 0.00</p>
            </div>
          </div>
          <p id="m-desc" class="text-slate-500 text-sm leading-relaxed mb-6">Loading description...</p>
          <div class="flex items-center justify-between bg-slate-50 p-4 rounded-xl border border-slate-100">
              <span class="font-bold text-slate-600 text-sm">Quantity</span>
              <div class="flex items-center gap-4">
                  <button class="w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm text-slate-600 font-bold text-lg active:scale-90 transition" onclick="updateModalQty(-1)">-</button>
                  <span id="m-qty" class="font-bold text-xl w-6 text-center">0</span>
                  <button class="w-10 h-10 bg-slate-900 text-white rounded-full shadow-lg shadow-slate-900/30 font-bold text-lg active:scale-90 transition theme-bg-dark" onclick="updateModalQty(1)">+</button>
              </div>
          </div>
          <button onclick="confirmModal()" class="w-full mt-4 bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-600/30 active:scale-95 transition theme-bg" data-i18n="add_to_cart">Update Cart</button>
      </div>
  </div>

  <div id="cart-modal" class="fixed bottom-0 left-0 right-0 z-[80] bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 max-h-[85vh] flex flex-col hidden">
    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-3xl">
        <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-basket-shopping text-orange-600 theme-text"></i> 
            <span data-i18n="cart_title">Semak Pesanan</span>
        </h2>
        <button onclick="closeCart()" class="w-8 h-8 bg-slate-200 text-slate-500 rounded-full flex items-center justify-center hover:bg-slate-300 transition"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="cart-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50"></div>
    <div class="p-4 border-t border-slate-100 bg-white pb-8 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] z-10">
        <div class="flex justify-between items-end mb-4">
            <span class="text-sm font-bold text-slate-500 uppercase tracking-wide">Subtotal</span>
            <span class="text-2xl font-extrabold text-slate-800" id="cart-subtotal">RM 0.00</span>
        </div>
        <button onclick="closeCart()" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition theme-bg-dark">
            <span data-i18n="continue">Sambung / Checkout</span>
        </button>
    </div>
  </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1zNzsKmXXLVsOVGnVeGwlT_0uX3XqdO0",
      authDomain: "pipahcookies-order.firebaseapp.com",
      databaseURL: "https://pipahcookies-order-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pipahcookies-order",
      storageBucket: "pipahcookies-order.firebasestorage.app",
      messagingSenderId: "1038900448087",
      appId: "1:1038900448087:web:a46586f21e9ae989708c12"
    };

    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let SHOP = {}, CART = [], DB_PRODUCTS = {}, curLang='ms';
    let currentModalIdx = -1;
    let selectedMethod = 'delivery';
    let cartSequence = 0;

    const i18n = {
        ms: { 
            your_info:"Maklumat Anda", menu:"Menu Pilihan", total:"Jumlah Besar", btn_order:"Hantar", 
            ph_name:"Nama Penuh", ph_addr:"Alamat Penghantaran", alert_name:"Sila isi nama.", alert_item:"Sila pilih biskut.", 
            promo_text:"Selamat Datang! Dapatkan biskut homemade fresh dari oven sekarang.", lbl_name:"NAMA", lbl_addr:"ALAMAT PENGHANTARAN", 
            add_to_cart:"Simpan Pilihan", m_delivery:"Penghantaran", m_pickup:"Ambil Sendiri", lbl_date:"TARIKH", lbl_time:"MASA",
            alert_addr: "Sila isi alamat.", alert_time: "Sila pilih tarikh & masa.", cart_title:"Semak Pesanan", continue:"Tutup"
        },
        en: { 
            your_info:"Your Details", menu:"Menu", total:"Grand Total", btn_order:"Send", 
            ph_name:"Full Name", ph_addr:"Delivery Address", alert_name:"Please enter name.", alert_item:"Please select items.", 
            promo_text:"Welcome! Get premium fresh cookies directly from the oven.", lbl_name:"NAME", lbl_addr:"DELIVERY ADDRESS", 
            add_to_cart:"Save Selection", m_delivery:"Delivery", m_pickup:"Self Pickup", lbl_date:"DATE", lbl_time:"TIME",
            alert_addr: "Please enter address.", alert_time: "Please select date & time.", cart_title:"Review Order", continue:"Close"
        }
    };

    function setLang(l) {
        curLang = l;
        document.getElementById('l-ms').className = l==='ms'?"px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold transition":"px-3 py-1 text-white/70 rounded-full text-[10px] font-bold transition";
        document.getElementById('l-en').className = l==='en'?"px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold transition":"px-3 py-1 text-white/70 rounded-full text-[10px] font-bold transition";
        
        document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = i18n[l][e.dataset.i18n]);
        document.getElementById('c_name').placeholder = i18n[l].ph_name;
        document.getElementById('c_addr').placeholder = i18n[l].ph_addr;
        document.getElementById('search-input').placeholder = l==='ms' ? 'Cari biskut...' : 'Search cookies...';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const shopId = params.get('id');
        const encoded = params.get('d');

        try {
            const snap = await db.collection('products').get();
            snap.forEach(d => DB_PRODUCTS[d.id] = d.data());

            if (shopId) {
                const doc = await db.collection('shops').doc(shopId).get();
                if (!doc.exists) throw new Error("Shop not found");
                SHOP = doc.data();
            } else if (encoded) {
                const str = decodeURIComponent(atob(encoded).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                SHOP = JSON.parse(str);
            } else { SHOP = { n: "PipahCookies", w: "60123456789", p:[], i:[] }; }

            if(SHOP.n && SHOP.n !== "PipahCookies") {
                 db.collection('reseller_visits').doc(SHOP.n).set({ count: firebase.firestore.FieldValue.increment(1), lastVisit: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
            }

            const hasDelivery = SHOP.fulfillment ? SHOP.fulfillment.delivery : true;
            const hasPickup = SHOP.fulfillment ? SHOP.fulfillment.pickup : true;

            if (!hasDelivery && hasPickup) { setMethod('pickup'); document.getElementById('btn-delivery').classList.add('hidden'); } 
            else if (hasDelivery && !hasPickup) { setMethod('delivery'); document.getElementById('btn-pickup').classList.add('hidden'); } 
            else { setMethod('delivery'); }

            if (SHOP.pm) document.getElementById('shop-promo').innerText = SHOP.pm;
            document.getElementById('shop-name').innerText = SHOP.n || 'PipahCookies';
            document.title = (SHOP.n || 'PipahCookies') + " - Order";
            
            if (SHOP.b) document.getElementById('header-bg').style.backgroundImage = `url('${SHOP.b}')`;
            if (SHOP.l) { const logo = document.getElementById('shop-logo'); logo.src = SHOP.l; logo.classList.remove('hidden'); }

            if (SHOP.c) {
                const c = SHOP.c;
                const style = document.createElement('style');
                style.innerHTML = `.theme-bg-dark, #header-container { background-color: ${c} !important; }.theme-bg, .active-tab { background-color: ${c} !important; border-color: ${c} !important; color: white !important; }.theme-text, .text-orange-600 { color: ${c} !important; }.theme-icon-bg { background-color: ${c}1a !important; color: ${c} !important; }.theme-ring:focus { --tw-ring-color: ${c} !important; }.loader { border-top-color: ${c} !important; }`;
                document.head.appendChild(style);
            }

            // --- STRICT PRODUCT DATA ENFORCEMENT ---
if(SHOP.i){
    SHOP.i.forEach((id, idx) => {
        const p = DB_PRODUCTS[id];
        if(p) {
            CART.push({ 
                id, 
                idx: idx, 
                name: p.name, // STRICT DB NAME (Cannot be edited)
                price: parseFloat(SHOP.p[idx]), 
                oldPrice: SHOP.op ? parseFloat(SHOP.op[idx]) : 0, 
                qty: 0, 
                image: p.image, // STRICT DB IMAGE (Cannot be edited)
                
                // MODIFIED: Uses SHOP.ds[idx] if available, otherwise uses DB description
                description: (SHOP.ds && SHOP.ds[idx]) ? SHOP.ds[idx] : p.description, 
                
                seq: 0 
            });
        }
    });
}

            
            document.getElementById('item-count').innerText = `${CART.length} Items`;
            render();
            document.getElementById('loader').classList.add('hidden');

        } catch(e) { console.error(e); document.getElementById('loader').innerHTML = '<p class="text-red-500 font-bold">Shop Error.</p>'; }
    });

    function setMethod(method) {
        selectedMethod = method;
        const btnDel = document.getElementById('btn-delivery');
        const btnPick = document.getElementById('btn-pickup');
        const inpDel = document.getElementById('delivery-input');
        const inpPick = document.getElementById('pickup-input');

        if(method === 'delivery') {
            btnDel.className = "flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 active-tab theme-bg";
            btnPick.className = "flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 inactive-tab";
            inpDel.classList.remove('hidden'); inpPick.classList.add('hidden');
        } else {
            btnPick.className = "flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 active-tab theme-bg";
            btnDel.className = "flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 inactive-tab";
            inpPick.classList.remove('hidden'); inpDel.classList.add('hidden');
        }
    }

    function render(filter = "") {
        const list = document.getElementById('product-list'); list.innerHTML = '';
        CART.forEach((item, idx) => {
            if(filter && !item.name.toLowerCase().includes(filter.toLowerCase())) return;
            let priceHTML = `<p class="text-orange-600 font-extrabold theme-text">RM ${item.price.toFixed(2)}</p>`;
            let badgeHTML = (idx === 0 && !filter) ? `<span class="absolute -top-2 -left-2 bg-yellow-400 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm z-10">BEST SELLER üî•</span>` : '';
            if (item.oldPrice > item.price) { priceHTML = `<div><span class="text-[10px] text-slate-400 line-through mr-1">RM${item.oldPrice.toFixed(2)}</span><span class="text-orange-600 font-extrabold theme-text">RM ${item.price.toFixed(2)}</span></div>`; }
            const qtyBadge = item.qty > 0 ? `<div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-white shadow-md z-10 animate-bounce">${item.qty}</div>` : '';

            list.innerHTML += `
            <div class="relative bg-white p-3 rounded-2xl border border-slate-100 shadow-sm flex gap-4 items-center transition active:scale-[0.98]" onclick="openModal(${idx})">
                ${badgeHTML}${qtyBadge}
                <img src="${item.image}" class="w-20 h-20 rounded-xl object-cover bg-gray-100 shadow-sm" loading="lazy">
                <div class="flex-1"><h4 class="font-bold text-slate-800 leading-tight mb-1 text-sm line-clamp-2">${item.name}</h4>${priceHTML}</div>
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i class="fa-solid fa-plus"></i></div>
            </div>`;
        });
    }

    function filterProducts() { render(document.getElementById('search-input').value); }
    
    function openModal(idx) {
        currentModalIdx = idx; const item = CART[idx];
        document.getElementById('m-img').src = item.image; 
        document.getElementById('m-name').innerText = item.name; 
        document.getElementById('m-price').innerText = `RM ${item.price.toFixed(2)}`;
        document.getElementById('m-qty').innerText = item.qty; 
        document.getElementById('m-desc').innerText = item.description || "Premium quality homemade cookies made with pure butter. Freshly baked.";
        if(item.oldPrice > item.price){ document.getElementById('m-old-price').innerText = `RM ${item.oldPrice.toFixed(2)}`; document.getElementById('m-old-price').classList.remove('hidden'); } else { document.getElementById('m-old-price').classList.add('hidden'); }
        
        document.getElementById('modal-backdrop').classList.remove('hidden'); 
        document.getElementById('product-modal').classList.remove('hidden');
        setTimeout(() => { document.getElementById('modal-backdrop').classList.remove('opacity-0'); document.getElementById('product-modal').classList.remove('translate-y-full'); }, 10);
    }
    
    function closeModal() { 
        document.getElementById('modal-backdrop').classList.add('opacity-0'); 
        document.getElementById('product-modal').classList.add('translate-y-full'); 
        setTimeout(() => { 
            document.getElementById('modal-backdrop').classList.add('hidden'); 
            document.getElementById('product-modal').classList.add('hidden'); 
        }, 300); 
    }

    function updateModalQty(d) { 
        let currentQ = parseInt(document.getElementById('m-qty').innerText); 
        if(currentQ + d < 0) return; 
        document.getElementById('m-qty').innerText = currentQ + d; 
    }
    
    function confirmModal() { 
        if(currentModalIdx > -1) { 
            const newQty = parseInt(document.getElementById('m-qty').innerText);
            if (CART[currentModalIdx].qty === 0 && newQty > 0) { CART[currentModalIdx].seq = ++cartSequence; }
            CART[currentModalIdx].qty = newQty; 
            recalcTotal(); 
            render(document.getElementById('search-input').value); 
            closeModal(); 
        } 
    }

    function recalcTotal() {
        let total = 0, count = 0; CART.forEach(c => { total += c.qty * c.price; count += c.qty; });
        document.getElementById('grand-total').innerText = "RM " + total.toFixed(2); 
        document.getElementById('total-qty').innerText = `(${count} items)`;
        document.getElementById('cart-subtotal').innerText = "RM " + total.toFixed(2);
        
        const bar = document.getElementById('cart-bar'); 
        if (count > 0) { bar.classList.remove('translate-y-full'); } else { bar.classList.add('translate-y-full'); }
    }

    function openCart() {
        renderCartList();
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('cart-modal').classList.remove('hidden');
        setTimeout(() => { document.getElementById('modal-backdrop').classList.remove('opacity-0'); document.getElementById('cart-modal').classList.remove('translate-y-full'); }, 10);
    }

    function closeCart() {
        document.getElementById('modal-backdrop').classList.add('opacity-0');
        document.getElementById('cart-modal').classList.add('translate-y-full');
        setTimeout(() => { document.getElementById('modal-backdrop').classList.add('hidden'); document.getElementById('cart-modal').classList.add('hidden'); }, 300);
    }

    function renderCartList() {
        const container = document.getElementById('cart-list');
        container.innerHTML = '';
        
        const sortedCart = CART.filter(c => c.qty > 0).sort((a, b) => a.seq - b.seq);
        
        if(sortedCart.length > 0) {
            sortedCart.forEach((item) => {
                container.innerHTML += `
                <div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                    <img src="${item.image}" class="w-16 h-16 rounded-lg object-cover bg-gray-100">
                    <div class="flex-1">
                        <h4 class="font-bold text-slate-800 text-sm line-clamp-1">${item.name}</h4>
                        <p class="text-orange-600 font-bold text-xs theme-text">RM ${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                        <button onclick="updateCartItemQty(${item.idx}, -1)" class="w-7 h-7 bg-white text-slate-600 rounded shadow-sm flex items-center justify-center font-bold active:scale-90 transition">-</button>
                        <span class="font-bold text-sm w-4 text-center">${item.qty}</span>
                        <button onclick="updateCartItemQty(${item.idx}, 1)" class="w-7 h-7 bg-white text-slate-600 rounded shadow-sm flex items-center justify-center font-bold active:scale-90 transition">+</button>
                    </div>
                </div>`;
            });
        } else {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-slate-400"><i class="fa-solid fa-basket-shopping text-4xl mb-2 opacity-30"></i><p class="text-sm font-medium">Cart is empty</p></div>`;
        }
    }

    function updateCartItemQty(idx, delta) {
        if(CART[idx].qty + delta < 0) return;
        if (CART[idx].qty === 0 && delta > 0) { CART[idx].seq = ++cartSequence; }
        CART[idx].qty += delta;
        recalcTotal(); renderCartList(); render(document.getElementById('search-input').value);
    }

    function shareShop() { if (navigator.share) { navigator.share({ title: SHOP.n, text: 'Check out these delicious cookies!', url: window.location.href }).catch(console.error); } else { alert("Copy Link: " + window.location.href); } }

    window.submitOrder = async () => {
        const name = document.getElementById('c_name').value.trim();
        const items = CART.filter(c => c.qty > 0).sort((a, b) => a.seq - b.seq);
        const addr = document.getElementById('c_addr').value.trim();
        const date = document.getElementById('c_date').value;
        const time = document.getElementById('c_time').value;

        if(!name) return alert(i18n[curLang].alert_name);
        if(items.length === 0) return alert(i18n[curLang].alert_item);
        if(selectedMethod === 'delivery' && !addr) return alert(i18n[curLang].alert_addr);
        if(selectedMethod === 'pickup' && (!date || !time)) return alert(i18n[curLang].alert_time);

        const btn = document.querySelector('button[onclick="submitOrder()"]');
        btn.innerHTML = `<i class="fa-solid fa-spinner animate-spin"></i> Processing...`;
        btn.disabled = true;

        try {
            const batch = db.batch();
            const orderRef = db.collection('orders').doc();
            let total = 0;
            const orderItems = items.map(i => { total += i.qty * i.price; return { id: i.id, name: i.name, qty: i.qty, price: i.price }; });

            batch.set(orderRef, {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                customerName: name, 
                customerAddress: selectedMethod === 'delivery' ? addr : `PICKUP: ${date} @ ${time}`, 
                method: selectedMethod,
                resellerName: SHOP.n || 'PipahCookies', resellerPhone: SHOP.w, items: orderItems, totalPrice: total, type: 'customer_order'
            });
            items.forEach(i => { batch.update(db.collection('products').doc(i.id), { soldCount: firebase.firestore.FieldValue.increment(i.qty) }); });
            await batch.commit();

            let msg = `*NEW ORDER: ${(SHOP.n || 'CUSTOMER').toUpperCase()}* üç™\n\nüë§ *${name}*\n`;
            if (selectedMethod === 'delivery') { msg += `üöö *DELIVERY*\nüìç ${addr}\n`; } else { msg += `üõçÔ∏è *SELF PICKUP*\nüìÖ ${date} @ ${time}\n`; }

            msg += `\n*ORDER LIST:*`;
            items.forEach(i => { msg += `\n‚ñ™Ô∏è ${i.qty}x ${i.name}`; });
            msg += `\n\n*TOTAL: RM ${total.toFixed(2)}*`;
            msg += `\n_Generated by PipahCookies App_`;
            
            window.location.href = `https://wa.me/${SHOP.w}?text=${encodeURIComponent(msg)}`;
        } catch (error) { console.error(error); alert("Error sending order. Redirecting to WhatsApp."); window.location.href = `https://wa.me/${SHOP.w}`; }
    }
</script>

</body>
</html>
