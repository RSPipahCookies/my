<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Order Cookies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 140px; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ea580c; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loader" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="font-bold text-slate-400 text-sm animate-pulse">Loading Shop...</p>
  </div>

  <div class="relative w-full h-64 bg-slate-900 overflow-hidden rounded-b-[2.5rem] shadow-2xl">
    <div class="absolute inset-0 bg-orange-600/90 mix-blend-multiply"></div>
    <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
    
    <div class="absolute top-4 right-4 z-20 flex bg-black/30 backdrop-blur rounded-full p-1">
        <button onclick="setLang('ms')" id="l-ms" class="px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold">MY</button>
        <button onclick="setLang('en')" id="l-en" class="px-3 py-1 text-white/70 rounded-full text-[10px] font-bold">EN</button>
    </div>

    <div class="absolute bottom-10 left-6 right-6 text-white z-10">
        <div class="inline-block bg-white/20 backdrop-blur px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-3 border border-white/10" data-i18n="agent_badge">Official Agent</div>
        <h1 id="shop-name" class="text-3xl font-extrabold leading-tight mb-2">...</h1>
        <p class="text-orange-100 text-sm flex items-center gap-2"><i class="fa-solid fa-truck-fast"></i> <span data-i18n="secure_msg">Fast Delivery & Secure</span></p>
    </div>
  </div>

  <div class="max-w-md mx-auto px-4 -mt-8 relative z-20 space-y-6">
    <div class="bg-white p-6 rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-100">
        <div class="flex items-center gap-2 mb-4 border-b border-slate-50 pb-2">
            <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 grid place-items-center"><i class="fa-regular fa-user"></i></div>
            <h3 class="text-sm font-bold text-slate-700 uppercase" data-i18n="your_info">Maklumat Anda</h3>
        </div>
        <div class="space-y-3">
            <input type="text" id="c_name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold text-slate-800 outline-none focus:ring-2 ring-orange-500 transition" placeholder="Nama Penuh">
            <textarea id="c_addr" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-medium outline-none focus:ring-2 ring-orange-500 transition" placeholder="Alamat Penghantaran"></textarea>
        </div>
    </div>

    <div>
        <h3 class="font-bold text-slate-800 mb-3 px-1" data-i18n="menu">Menu Pilihan</h3>
        <div id="product-list" class="space-y-3"></div>
    </div>
  </div>

  <div class="fixed bottom-6 left-4 right-4 z-40 max-w-md mx-auto transition-all duration-300 transform translate-y-40" id="cart-bar">
    <div class="bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between border border-slate-700">
        <div>
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider" data-i18n="total">Jumlah Besar</p>
            <p class="text-2xl font-bold leading-none" id="grand-total">RM 0.00</p>
        </div>
        <button onclick="submitOrder()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition flex items-center gap-2 shadow-lg shadow-green-500/30 active:scale-95">
            <i class="fa-brands fa-whatsapp text-xl"></i>
            <span data-i18n="btn_order">Order</span>
        </button>
    </div>
  </div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyA2Y2cOh3J7U916Ip0tnDDFVs2fK6sACl0", authDomain: "pipahcookies-21e38.firebaseapp.com", projectId: "pipahcookies-21e38", storageBucket: "pipahcookies-21e38.firebasestorage.app", messagingSenderId: "162482379926", appId: "1:162482379926:web:14d16f5a2444816876f6b7" };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let SHOP = {}, CART = [], DB_PRODUCTS = {}, curLang='ms';
    const i18n = {
        ms: { agent_badge:"Ejen Sah", secure_msg:"Pantas & Selamat", your_info:"Maklumat Anda", menu:"Menu Pilihan", total:"Jumlah Besar", btn_order:"Order WhatsApp", ph_name:"Nama Penuh", ph_addr:"Alamat Penghantaran", alert_name:"Sila isi nama.", alert_item:"Sila pilih biskut." },
        en: { agent_badge:"Official Agent", secure_msg:"Fast & Secure", your_info:"Your Details", menu:"Menu Selection", total:"Grand Total", btn_order:"Order via WhatsApp", ph_name:"Full Name", ph_addr:"Delivery Address", alert_name:"Please enter name.", alert_item:"Please select items." }
    };

    function setLang(l) {
        curLang = l;
        document.getElementById('l-ms').className = l==='ms'?"px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold":"px-3 py-1 text-white/70 rounded-full text-[10px] font-bold";
        document.getElementById('l-en').className = l==='en'?"px-3 py-1 bg-white/20 text-white rounded-full text-[10px] font-bold":"px-3 py-1 text-white/70 rounded-full text-[10px] font-bold";
        
        document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = i18n[l][e.dataset.i18n]);
        document.getElementById('c_name').placeholder = i18n[l].ph_name;
        document.getElementById('c_addr').placeholder = i18n[l].ph_addr;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const encoded = new URLSearchParams(window.location.search).get('d');
        if(encoded) {
            try {
                const str = decodeURIComponent(atob(encoded).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                SHOP = JSON.parse(str);
                document.getElementById('shop-name').innerText = SHOP.n || 'Reseller Shop';
                
                const snap = await db.collection('products').get();
                snap.forEach(d => DB_PRODUCTS[d.id] = d.data());
                
                SHOP.i.forEach((id, idx) => {
                    const p = DB_PRODUCTS[id];
                    if(p) CART.push({ id, name: p.name, price: parseFloat(SHOP.p[idx]), qty: 0, image: p.image });
                });
                render();
                document.getElementById('loader').classList.add('hidden');
            } catch(e) { console.error(e); alert("Invalid Link"); }
        }
    });

    function render() {
        const list = document.getElementById('product-list'); list.innerHTML = '';
        CART.forEach((item, idx) => {
            list.innerHTML += `
            <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex gap-4 items-center transition">
                <img src="${item.image}" class="w-20 h-20 rounded-xl object-cover bg-gray-100">
                <div class="flex-1">
                    <h4 class="font-bold text-slate-800 leading-tight mb-1">${item.name}</h4>
                    <p class="text-orange-600 font-extrabold">RM ${item.price.toFixed(2)}</p>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 p-1 rounded-lg border border-slate-100">
                    <button class="w-8 h-8 bg-white text-slate-600 rounded-md shadow-sm font-bold" onclick="upd(${idx}, -1)">-</button>
                    <span class="font-bold text-sm w-4 text-center select-none" id="q-${idx}">${item.qty}</span>
                    <button class="w-8 h-8 bg-slate-900 text-white rounded-md shadow-sm font-bold" onclick="upd(${idx}, 1)">+</button>
                </div>
            </div>`;
        });
    }

    window.upd = (idx, d) => {
        if(CART[idx].qty + d < 0) return;
        CART[idx].qty += d;
        document.getElementById(`q-${idx}`).innerText = CART[idx].qty;
        let total = 0, count = 0;
        CART.forEach(c => { total += c.qty * c.price; count += c.qty; });
        document.getElementById('grand-total').innerText = "RM " + total.toFixed(2);
        const bar = document.getElementById('cart-bar'); count > 0 ? bar.classList.remove('translate-y-40') : bar.classList.add('translate-y-40');
    }

    window.submitOrder = async () => {
        const name = document.getElementById('c_name').value.trim();
        const addr = document.getElementById('c_addr').value.trim();
        const items = CART.filter(c => c.qty > 0);
        if(!name) return alert(i18n[curLang].alert_name);
        if(items.length === 0) return alert(i18n[curLang].alert_item);

        try {
            const batch = db.batch();
            const orderRef = db.collection('orders').doc();
            let total = 0;
            const orderItems = items.map(i => { total += i.qty * i.price; return { id: i.id, name: i.name, qty: i.qty, price: i.price }; });

            batch.set(orderRef, {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                customerName: name, customerAddress: addr, resellerName: SHOP.n, resellerPhone: SHOP.w, items: orderItems, totalPrice: total, type: 'customer_order'
            });
            items.forEach(i => { batch.update(db.collection('products').doc(i.id), { soldCount: firebase.firestore.FieldValue.increment(i.qty) }); });
            await batch.commit();

            let msg = `*ORDER ${SHOP.n.toUpperCase()}* üëã\nüë§ ${name}\n`;
            if(addr) msg += `üìç ${addr}\n`;
            msg += `\n*ITEMS:*`;
            items.forEach(i => { msg += `\n‚ñ™Ô∏è ${i.qty}x ${i.name}`; });
            msg += `\n\n*TOTAL: RM ${total.toFixed(2)}*`;
            
            window.location.href = `https://wa.me/${SHOP.w}?text=${encodeURIComponent(msg)}`;
        } catch (error) { window.location.href = `https://wa.me/${SHOP.w}`; }
    }
  </script>
</body>
</html>
