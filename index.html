<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PipahCookies â€” Reseller Portal (Gabungan)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* --- General Styles (from index (8).html) --- */
    :root{
      --primary: #A67734; /* Rich Brown/Gold Accent */
      --primary-dark: #6C4920; /* Darker Brown for Text/Headers (using RSDashboard color) */
      --accent: #F4EAE0; /* Soft Beige/Cream Background (using RSDashboard color) */
      --whatsapp:#25d366;
      --bg:#F9F7F5; /* Very Light Beige Background (using RSDashboard color) */
      --card:#ffffff;
      --muted:#888888;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter', sans-serif;background:var(--bg);color:#333;-webkit-font-smoothing:antialiased}
    h1,h2,h3{font-family:'Inter', sans-serif;color:var(--primary-dark);margin:0 0 12px;font-weight:700}
    a{color:inherit}

    /* --- LOGIN GATE STYLES (from Reseller Portal.html) --- */
    #login-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
        text-align: center;
    }
    .login-box {
        background: var(--card); padding: 40px; border-radius: 12px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.15); width: 90%; max-width: 400px;
        animation: fadeIn 0.5s both;
    }
    .login-box input {
        width: 100%; padding: 12px; margin: 8px 0 15px; border: 1px solid #ddd;
        border-radius: 8px; font-size: 1em;
    }
    .login-box button {
        width: 100%; background: var(--primary); color: white; padding: 12px;
        border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        transition: background 0.2s;
    }
    .login-box button:hover { background: var(--primary-dark); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* --- RSDASHBOARD & index (8) styles (Combined & Reused) --- */
    .site-header{display:block}
    .header-img{width:100%;height:auto;display:block;object-fit:cover;max-height:300px;border-radius:0 0 18px 18px;box-shadow:0 12px 25px rgba(0,0,0,0.1);animation:fadeUp .9s both}
    .site-nav{position:sticky;top:0;background:var(--primary);z-index:1000;box-shadow:0 2px 4px rgba(0,0,0,0.1);padding:10px 0}
    .nav-list{display:flex;justify-content:center;max-width:1200px;margin:0 auto;list-style:none;padding:0}
    .nav-list a{text-decoration:none;color:var(--accent);padding:10px 15px;border-radius:6px;transition:background-color .2s;font-weight:600;}
    .nav-list a:hover{background-color:rgba(255,255,255,0.2)}
    
    .container{max-width:1200px;margin:30px auto;padding:0 20px}
    .section{padding:40px 0;border-bottom:1px solid rgba(0,0,0,0.08)}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.05);transition:transform .3s;text-align:center;}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.1);}
    .input-group{margin-bottom:15px}
    .input-group label{display:block;margin-bottom:5px;font-weight:600;color:var(--primary-dark);font-size:0.95em;}
    .input-group input, .input-group select{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:1em;color:#444}
    
    /* Cart Styles from index (8) */
    .products { display:flex;flex-wrap:wrap;gap:20px;justify-content:center }
    .product-card { flex:0 0 calc(33.333% - 20px); height:420px; background:var(--card); padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); overflow:hidden; text-align:center; display:flex; flex-direction:column; justify-content:space-between }
    @media (max-width: 900px){ .product-card{flex:0 0 calc(50% - 20px)} }
    @media (max-width:600px){ .product-card{flex:0 0 calc(100% - 20px)} }
    
    /* RSDashboard specific styles (to ensure proper rendering) */
    .product-checkbox-item { display: flex; align-items: center; margin-bottom: 10px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; }
    .product-checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; }
    .product-checkbox-item img { width: 45px; height: 45px; object-fit: cover; border-radius: 8px; margin-right: 12px; }
    .profit-result span{font-size:1.8em;font-weight:700;color:var(--whatsapp);display:block;margin-top:5px;}

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2 style="color:var(--primary);">Sistem Log Masuk Reseller</h2>
      <p style="color:var(--muted); margin-bottom: 20px;">Sila masukkan Nombor WhatsApp dan PIN Akses anda.</p>
      
      <label for="login-whatsapp" class="text-left block text-sm font-semibold text-gray-700">Nombor WhatsApp (e.g. 60123456789)</label>
      <input type="tel" id="login-whatsapp" placeholder="Nombor WhatsApp" required>
      
      <label for="login-pin" class="text-left block text-sm font-semibold text-gray-700">PIN Akses 6-Digit</label>
      <input type="password" id="login-pin" placeholder="6-Digit PIN" maxlength="6" pattern="\d{6}" required>
      
      <button onclick="login()">LOG IN</button>
      
      <p style="margin-top: 20px; font-size: 0.9em; color: var(--muted);">
        Belum daftar? Sila daftar di <a href="reseller-registration.html" style="color:var(--primary); font-weight: bold;">reseller-registration.html</a>
      </p>
    </div>
  </div>

  <div id="reseller-dashboard" style="display:none;">
    
    <header class="site-header">
      <img src="images/rsheader.png" alt="Pipah Cookies Reseller Portal" class="header-img">
    </header>

    <nav class="site-nav">
      <ul class="nav-list">
        <li><a href="#dashboard-tools">Dashboard Tools</a></li>
        <li><a href="#products">Produk & Tempahan</a></li>
        <li><a href="#syarat">Syarat Jualan</a></li>
      </ul>
    </nav>
    
    <div class="container">
        
      <section id="dashboard-tools" class="section">
        <h2 class="text-center text-4xl mb-10">Reseller Dashboard Tools</h2>
        
        <section id="bulk" class="mb-10">
          <h2 class="text-center text-3xl">Struktur Belian Pukal (Stok Reseller)</h2>
          <div class="flex flex-col md:flex-row gap-6 justify-center max-w-4xl mx-auto">
            <div class="card md:w-1/2">
              <h3>Pakej Mini (1 - 29 unit)</h3>
              <p class="text-lg text-gray-700">Diskaun: <strong class="text-primary-dark">15%</strong> dari RRP</p>
              <p class="text-sm mt-3 text-gray-500">Kos Reseller: Lihat dalam Kalkulator Keuntungan.</p>
            </div>
            <div class="card md:w-1/2">
              <h3>Pakej Emas (30 unit ke atas)</h3>
              <p class="text-lg text-gray-700">Diskaun: <strong class="text-primary-dark">20%</strong> dari RRP</p>
              <p class="text-sm mt-3 text-gray-500">Unit boleh dicampur antara produk untuk mencapai 30 unit.</p>
            </div>
          </div>
        </section>
        
        <section id="generator" class="section bg-accent p-8 rounded-2xl shadow-xl">
          <h2 class="text-center text-3xl" style="color:#10b981;"><i class="fas fa-share-alt"></i> Jana Pautan Jualan Multi-Produk</h2>
          <p class="text-center text-gray-600 mb-8">
            Tetapkan harga runcit *setiap* produk yang anda ingin jual dan pilih produk yang akan dimasukkan ke dalam pautan.
          </p>

          <div class="max-w-2xl mx-auto">
            <div class="input-group">
              <label for="whatsappNumber">Nombor WhatsApp Anda (e.g. 60123456789)</label>
              <input type="tel" id="whatsappNumber" placeholder="Sila masukkan nombor WhatsApp penuh" value="" class="shadow-sm" readonly> 
            </div>
            <hr class="my-6 border-primary/20">
            <h3 class="text-xl font-semibold text-center mb-4 text-primary-dark">Tetapkan Harga & Pilih Produk untuk Pautan Jualan</h3>
            
            <div id="selectionCheckboxesContainer" class="max-h-80 overflow-y-auto p-3 border border-gray-200 rounded-lg bg-white">
              </div>

            <div id="priceInputsContainer" class="mt-4 flex flex-col gap-3">
              </div>
            
            <hr class="my-6 border-primary/20">
            <button class="btn primary-btn w-full" style="background:var(--whatsapp)" onclick="generateLink()">
              <i class="fas fa-link"></i> Jana & Papar Pautan Jualan
            </button>
            <div class="mt-4 bg-gray-100 p-3 rounded-lg flex justify-between items-center hidden" id="generatedLinkContainer">
              <span id="salesLink" class="text-sm text-gray-700 truncate mr-3"></span>
              <button onclick="copyLink()" class="btn secondary-btn flex-shrink-0 text-xs py-2 px-3">SALIN</button>
            </div>
            <p id="link-output" class="text-sm text-gray-500 mt-2 hidden" style="word-break: break-all;"></p>
          </div>
        </section>
      </section>
      
      <hr class="my-8">
      
      <main>
        <section id="syarat" class="section">
          <h2 style="text-align:center;color:var(--primary-dark);">Syarat - Syarat Tempahan Stok Reseller</h2>
          <div class="syarat-box" style="max-width:920px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.9),var(--accent));padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(166,119,52,0.08);border:1px solid rgba(166,119,52,0.06)">
            <p style="margin:0;font-weight:700;color:var(--primary-dark)">Harap baca sebelum membuat pesanan stok:</p>
            <ul>
              <li><strong>Deposit:</strong> 50% deposit diperlukan semasa membuat pesanan.</li>
              <li><strong>Masa Siap:</strong> Freshly baked upon order â€” biasanya 2â€“3 hari bergantung kepada kuantiti.</li>
              <li><strong>Bayaran Penuh:</strong> Bayaran penuh perlu diselesaikan semasa pengambilan.</li>
              <li><strong>Harga Jualan:</strong> Retail price dikawal bebas oleh reseller.</li>
              <li><strong>Pembatalan:</strong> Pembatalan selepas 24 jam dari tempahan akan kehilangan deposit.</li>
            </ul>
          </div>
        </section>

        <section id="products" class="section">
          <h2 style="text-align:center;color:var(--primary-dark);margin-bottom:16px">Pesan Stok Reseller Anda</h2>
          <div class="products" id="product-grid">
            </div>
        </section>
         
        <section id="gallery">
          <iframe 
              src="gambar2reseller.html" 
              width="100%" 
              style="border:none;" 
              id="galleryIframe" 
              scrolling="no">
          </iframe>
        </section>

        <section id="contact" class="section">
          <h2>Hubungi Kami</h2>
          <p class="lead" style="max-width:900px;margin:0 auto;color:var(--muted);line-height:1.6">Untuk pertanyaan stok, hantarkan mesej melalui WhatsApp Admin.</p>
          <p><a class="btn primary" href="#" onclick="window.open('https://wa.me/601121243407','_blank')" style="display:inline-block;padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;background:var(--primary);color:#fff">Chat Admin di WhatsApp</a></p>
        </section>
      </main>

      <button id="cart-icon" aria-label="Troli" onclick="toggleCart()" style="position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;z-index:120;box-shadow:0 14px 30px rgba(0,0,0,0.16)">
        <span class="icon">ðŸ›’</span>
        <span id="cart-badge" style="position:absolute;top:6px;right:6px;background:#ff3b3b;color:#fff;padding:3px 7px;border-radius:50%;font-weight:800;font-size:12px;box-shadow:0 6px 12px rgba(0,0,0,0.12)">0</span>
      </button>

      <aside id="cart-panel" class="cart-panel" aria-live="polite" aria-hidden="true" style="position:fixed;right:20px;bottom:92px;width:340px;max-height:72vh;overflow:auto;background:#fff;padding:12px;border-radius:12px;box-shadow:0 30px 60px rgba(0,0,0,0.18);z-index:120;transform:translateY(10px);opacity:0;pointer-events:none">
        <div class="cart-header" style="display:flex;justify-content:space-between;align-items:center">
          <h3>Troli Stok Anda</h3>
          <button class="close-cart" onclick="toggleCart()" style="background:transparent;border:none;font-size:18px;cursor:pointer">âœ•</button>
        </div>

        <ul id="cart-items" class="cart-items" style="list-style:none;padding:0;margin:10px 0;display:flex;flex-direction:column;gap:8px"></ul>

        <div class="cart-summary" style="margin-top:6px">
          <p id="cart-total">Jumlah: RM 0.00</p>
        </div>

        <div id="checkout-form" class="checkout-form hidden" style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <label for="orderId">No. Pesanan</label>
          <input type="text" id="orderId" name="orderId" readonly style="background:#f4f4f4;padding:8px;border-radius:8px;border:1px solid #eee;">
          <input id="full-name" type="text" placeholder="Nama penuh (Reseller)" style="padding:8px;border-radius:8px;border:1px solid #eee;"/>
          <textarea id="full-address" placeholder="Alamat penuh (optional)" style="padding:8px;border-radius:8px;border:1px solid #eee;"></textarea>
          <button class="btn checkout" id="go-to-summary" style="background:var(--whatsapp);color:#fff;padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;">Teruskan ke Ringkasan</button>
        </div>

        <div class="cart-actions" style="margin-top:10px;display:flex;gap:8px;justify-content:space-between">
          <button class="btn primary" id="open-checkout" onclick="showCheckoutForm()" style="background:var(--primary);color:#fff;padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;">Checkout Stok</button>
        </div>
      </aside>
    </div> <div class="fab-container" style="position:fixed;bottom:20px;right:20px;z-index:1001">
      <button class="fab-btn" id="calc-fab-btn" onclick="toggleCalculator()" style="background:var(--primary);color:#fff;border:none;border-radius:50%;width:56px;height:56px;font-size:1.5em;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;font-weight:bold;">
        RM
      </button>
    </div>

    <div id="calculatorModal" class="calculator-modal hidden" onclick="closeModal(event)" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1002;align-items:center;justify-content:center">
      <div class="calculator-content" style="background:var(--card);padding:30px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,0.3);width:90%;max-width:400px;">
        <h3 class="text-2xl font-bold text-center text-primary-dark mb-4">Kalkulator Keuntungan</h3>
        
        <div class="input-group">
          <label for="calcProduct">Pilih Produk</label>
          <select id="calcProduct" onchange="calculateProfit()">
            </select>
        </div>
        
        <div class="input-group">
          <label for="calcRetailPrice">Harga Jualan Runcit Anda (RM)</label>
          <input type="number" id="calcRetailPrice" step="0.50" min="1" value="25.00" oninput="calculateProfit()" class="text-xl font-bold text-primary-dark">
        </div>
        
        <div class="input-group">
          <label for="calcQuantity">Kuantiti (Unit)</label>
          <input type="number" id="calcQuantity" min="1" value="10" oninput="calculateProfit()">
        </div>
        
        <div class="my-5 p-5 rounded-xl border-2 border-primary-dark bg-accent/70">
          <p class="text-sm text-gray-700 mb-3">Kos Reseller Per Unit (Diskaun <span id="calcDiscount">15%</span>): <strong id="calcCostPerUnit">RM 21.25</strong></p>
          <p class="text-xl font-semibold text-primary-dark">Keuntungan Kasar Total:</p>
          <div class="profit-result">
            <span id="calcProfit">RM 0.00</span>
          </div>
        </div>
        
        <button class="close-btn" onclick="toggleCalculator()" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;color:var(--muted);"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>
  <script>
  // ===== CONFIG & DATA (Merged from index (8) and RSDashboard.html) =====
  const ADMIN_WHATSAPP_NUMBER = '601121243407'; 
  const RESELLERS_KEY = 'pipah_resellers'; 
  const CART_KEY = 'pipah_cart_v3'; 
  
  // RSDashboard Product Data (For Link Generator & Profit Calculator)
  const PRODUCTS = [
    { id: 'P1', name: 'Seasalt Chocolate Cookies', rrp: 25.00, cost_tier1: 21.25, cost_tier2: 20.00, img_url: 'https://placehold.co/150x150/A67734/ffffff?text=Cookies' },
    { id: 'P2', name: 'Premium Choc Chip Cookies', rrp: 30.00, cost_tier1: 25.50, cost_tier2: 24.00, img_url: 'https://placehold.co/150x150/A67734/ffffff?text=ChocChip' },
    { id: 'P3', name: 'Almond Crispies', rrp: 18.00, cost_tier1: 15.30, cost_tier2: 14.40, img_url: 'https://placehold.co/150x150/A67734/ffffff?text=Almond' },
    { id: 'P4', name: 'Peanut Butter Cookies', rrp: 22.00, cost_tier1: 18.70, cost_tier2: 17.60, img_url: 'https://placehold.co/150x150/A67734/ffffff?text=Peanut' },
    { id: 'P5', name: 'Red Velvet Cookies', rrp: 28.00, cost_tier1: 23.80, cost_tier2: 22.40, img_url: 'https://placehold.co/150x150/A67734/ffffff?text=RedVelvet' },
    // Add more RSDashboard product data here...
  ];

  // index (8).html Product Data (For Stock Ordering)
  const products = [
    { id: 'p1', title: 'Seasalt Cookies (65pcs)', images: ['images/ss1.jpg','images/ss2.jpg','images/ss3.jpg'], oldPrice: 16,
      tiers: [ { max: 4, price: 16 }, { max: 9, price: 15 }, { max: Infinity, price: 14 } ] },
    { id: 'p2', title: 'ChocHazelnut Button (38pcs)', images: ['images/ch1.jpg','images/ch2.jpg','images/ch3.jpg'], oldPrice: 22,
      tiers: [ { max: 4, price: 22 }, { max: 9, price: 20 }, { max: Infinity, price: 18 } ] },
    // Add more index (8).html product data here...
  ];

  // ===== LOGIN LOGIC (from Reseller Portal.html) =====
  let resellerWaNumber = null;

  function getRegisteredUsers() {
    return JSON.parse(localStorage.getItem(RESELLERS_KEY) || '{}');
  }

  function login() {
    const phone = document.getElementById('login-whatsapp').value.trim();
    const pin = document.getElementById('login-pin').value.trim();
    const users = getRegisteredUsers();

    if (!phone || !pin) {
      alert('Sila isi Nombor WhatsApp dan PIN Akses.');
      return;
    }

    if (users[phone] && users[phone].accessCode === pin) {
      if (users[phone].isBlocked) {
        alert('Akses anda telah disekat oleh Admin. Sila hubungi Admin.');
        return;
      }
      
      // SUCCESSFUL LOGIN
      resellerWaNumber = phone;
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('reseller-dashboard').style.display = 'block';
      
      // Run all initializers for the dashboard and portal
      initDashboard();
      initPortal();

      // Set the reseller's WhatsApp number in the generator section
      document.getElementById('whatsappNumber').value = phone;

    } else {
      alert('Nombor WhatsApp atau PIN Akses tidak sah.');
    }
  }
  // ===== RSDASHBOARD LOGIC (from RSDashboard.html) =====

  function initDashboard(){
    loadProductPricesForLinkGenerator();
    loadSelectionCheckboxes();
    loadCalculatorOptions(); // Initial load for calculator options
    calculateProfit(); // Initial calculation for calculator
  }

  // --- SALES LINK GENERATOR LOGIC ---
  function loadProductPricesForLinkGenerator() {
    const container = document.getElementById('priceInputsContainer');
    container.innerHTML = PRODUCTS.map(p => `
      <div class="input-group flex items-center justify-between gap-4 bg-white p-3 rounded-lg border border-gray-100">
        <label for="price_${p.id}" class="mb-0 font-normal text-gray-700 flex-grow">${p.name} (RRP: RM ${p.rrp.toFixed(2)})</label>
        <input type="number" id="price_${p.id}" step="0.50" min="1" value="${p.rrp.toFixed(2)}" placeholder="RM ${p.rrp.toFixed(2)}" class="w-32 text-right">
      </div>
    `).join('');
  }

  function loadSelectionCheckboxes() {
    const container = document.getElementById('selectionCheckboxesContainer');
    container.innerHTML = PRODUCTS.map((p, index) => `
      <div class="product-checkbox-item">
        <input type="checkbox" id="check_${p.id}" value="${p.id}" ${index < 3 ? 'checked' : ''}>
        <img src="${p.img_url}" alt="${p.name}">
        <label for="check_${p.id}" class="flex-grow font-medium text-gray-700 cursor-pointer">${p.name}</label>
      </div>
    `).join('');
  }

  function generateLink() {
    const whatsapp = document.getElementById('whatsappNumber').value.trim();
    if (!whatsapp) { alert('Sila log masuk semula atau masukkan Nombor WhatsApp.'); return; }

    const selectedProducts = PRODUCTS.filter(p => document.getElementById(`check_${p.id}`) && document.getElementById(`check_${p.id}`).checked);

    if (selectedProducts.length === 0) {
      alert('Sila pilih sekurang-kurangnya satu produk.');
      return;
    }

    const productIds = [];
    const customPrices = [];

    selectedProducts.forEach(p => {
      const priceInput = document.getElementById(`price_${p.id}`);
      const price = parseFloat(priceInput.value);

      if (isNaN(price) || price <= 0) {
        alert(`Harga untuk ${p.name} tidak sah.`);
        return;
      }
      productIds.push(p.id);
      customPrices.push(price.toFixed(2));
    });

    if (productIds.length === 0) return;

    // Structure of the link: OrderNow.html?rs_wa=60xxxxxx&p_ids=id1,id2&p_prices=price1,price2
    // Use a placeholder domain for local testing. This must be run on a web server for clean links.
    const currentDomain = window.location.protocol + '//' + window.location.host + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));

    const idsString = productIds.join(',');
    const pricesString = customPrices.join(',');
    
    const generatedLink = `${currentDomain}/OrderNow.html?rs_wa=${whatsapp}&p_ids=${idsString}&p_prices=${pricesString}`;

    const linkContainer = document.getElementById('generatedLinkContainer');
    const salesLinkInput = document.getElementById('salesLink');
    salesLinkInput.textContent = generatedLink;
    linkContainer.classList.remove('hidden');
    
    alert('Pautan Jualan Multi-Produk telah dijana! Salin dan kongsikan.');
  }

  function copyLink() {
    const linkText = document.getElementById('salesLink').textContent;
    navigator.clipboard.writeText(linkText).then(() => {
        alert('Pautan telah disalin ke clipboard!');
    }).catch(() => {
        alert('Gagal menyalin. Sila salin manual dari kotak di atas.');
    });
  }


  // --- PROFIT CALCULATOR LOGIC ---
  function loadCalculatorOptions() {
    const select = document.getElementById('calcProduct');
    select.innerHTML = PRODUCTS.map(p => `<option value="${p.id}">${p.name} (RRP: RM ${p.rrp.toFixed(2)})</option>`).join('');
  }

  function calculateProfit() {
    const productId = document.getElementById('calcProduct').value;
    const retailPrice = parseFloat(document.getElementById('calcRetailPrice').value);
    const quantity = parseInt(document.getElementById('calcQuantity').value);
    
    const product = PRODUCTS.find(p => p.id === productId);

    if (!product || isNaN(retailPrice) || retailPrice < 1 || isNaN(quantity) || quantity < 1) {
      document.getElementById('calcProfit').textContent = 'RM 0.00';
      document.getElementById('calcCostPerUnit').textContent = 'RM 0.00';
      document.getElementById('calcDiscount').textContent = '0%';
      return;
    }

    let costPerUnit;
    let discountPercentage;

    if (quantity >= 30) {
      costPerUnit = product.cost_tier2;
      discountPercentage = '20%';
    } else {
      costPerUnit = product.cost_tier1;
      discountPercentage = '15%';
    }
    
    const profit = (retailPrice - costPerUnit) * quantity;
    
    document.getElementById('calcCostPerUnit').textContent = `RM ${costPerUnit.toFixed(2)}`;
    document.getElementById('calcDiscount').textContent = discountPercentage;
    document.getElementById('calcProfit').textContent = `RM ${profit.toFixed(2)}`;
  }

  function toggleCalculator() {
    const modal = document.getElementById('calculatorModal');
    modal.classList.toggle('open');
    if (modal.classList.contains('open')) {
      modal.style.display = 'flex';
      calculateProfit(); 
    } else {
      setTimeout(() => modal.style.display = 'none', 300);
    }
  }

  function closeModal(event) {
    if (event.target.id === 'calculatorModal') {
      toggleCalculator();
    }
  }


  // ===== ORIGINAL PORTAL LOGIC (from index (8).html) =====

  let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');

  function initPortal(){
    renderProducts();
    updateCartUI();
    // Initialize animations and order number if needed
    document.querySelectorAll('.fade-up').forEach((el,i)=> el.style.animationDelay = (i*80)+'ms');
    const orderIdInput = document.getElementById('orderId');
    if(orderIdInput) orderIdInput.value = getNextOrderNumber();
    
    // Add event listener for the "Teruskan ke Ringkasan" button
    document.getElementById('go-to-summary').addEventListener('click', ()=>{ 
      const name = document.getElementById('full-name').value.trim();
      if(!name){ alert('Sila isi nama penuh reseller.'); return; }
      
      const order = { 
        orderId: document.getElementById('orderId').value, 
        name, 
        address: document.getElementById('full-address').value.trim(), 
        date: new Date().toISOString(), 
        items: cart 
      };
      
      localStorage.setItem('pipah_reseller_order', JSON.stringify(order));
      window.open('reseller-checkout.html', '_blank'); // Opens the dedicated checkout page
    });
  }

  // Helper for generating unique order ID (simple increment counter)
  function getNextOrderNumber() {
    let counter = parseInt(localStorage.getItem('order_counter') || '1000');
    return 'RS-' + (++counter);
  }

  function getUnitPriceForQty(productId, qty){
    const prod = products.find(p => p.id === productId);
    if(!prod || !prod.tiers) return 0;
    for(const t of prod.tiers){
      if(qty <= t.max) return t.price;
    }
    return prod.tiers[prod.tiers.length - 1].price;
  } 

  function renderProducts(){
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';
    products.forEach(prod => {
      const card = document.createElement('article');
      card.className = 'card product-card';
      // ... (rest of the render logic for index (8).html product cards)
      card.innerHTML = `
        <div class="product-slider" data-id="${prod.id}">
          ${prod.images.map((src,i)=>`<img src="${src}" class="product-img ${i===0?'active':''}" alt="${prod.title}" style="width:100%;height:240px;object-fit:cover;">`).join('')}
          <div class="slider-dots">
            ${prod.images.map((_,i)=>`<span class="dot ${i===0?'active':''}" data-index="${i}"></span>`).join('')}
          </div>
        </div>
        <h3>${prod.title}</h3>
        <p class="old-price">RRP: RM ${prod.oldPrice.toFixed(2)}</p>
        <div style="font-size:14px;color:#444;margin-bottom:6px">
          Harga per unit (Stok): <strong id="unit-${prod.id}">RM ${getUnitPriceForQty(prod.id, 1).toFixed(2)}</strong>
        </div>
        <div class="qty-control">
          <button class="qty-btn" onclick="updateQty('${prod.id}', -1)">âˆ’</button>
          <input type="number" id="qty-${prod.id}" value="1" min="1" oninput="updatePriceDisplay('${prod.id}')" class="qty-input">
          <button class="qty-btn" onclick="updateQty('${prod.id}', 1)">+</button>
        </div>
        <button class="btn primary w-full" data-id="${prod.id}" onclick="onAddToCart(event)" style="padding:10px 14px;border-radius:22px;border:none;cursor:pointer;font-weight:800;background:var(--primary);color:#fff;">
          Tambah ke Troli
        </button>
      `;
      grid.appendChild(card);
    });
  }

  function updateQty(id, change){
    const input = document.getElementById('qty-'+id);
    let qty = parseInt(input.value||'1') + change;
    if(qty < 1) qty = 1;
    input.value = qty;
    updatePriceDisplay(id);
  }

  function updatePriceDisplay(id){
    const qty = parseInt(document.getElementById('qty-'+id).value||'1');
    const el = document.getElementById('unit-'+id);
    if(!el) return;
    const price = getUnitPriceForQty(id, qty);
    el.textContent = 'RM '+price.toFixed(2);
  }

  function onAddToCart(e){
    const id = e.currentTarget.dataset.id;
    const qty = parseInt(document.getElementById('qty-'+id).value||'1');
    const unit = getUnitPriceForQty(id, qty);
    const prod = products.find(p=>p.id===id);
    const existing = cart.find(i=> i.id===id && i.unitPrice===unit);
    
    if(existing){
      existing.qty += qty;
    } else {
      cart.push({ id, name:prod.title, unitPrice:unit, qty });
    } 
    saveCart();
    updateCartUI();
    const icon = document.getElementById('cart-icon');
    icon.classList.add('added');
    setTimeout(()=> icon.classList.remove('added'),480);
  }

  function saveCart(){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function updateCartUI(){
    const list = document.getElementById('cart-items');
    const totalEl = document.getElementById('cart-total');
    const badge = document.getElementById('cart-badge');
    list.innerHTML='';
    let subtotal=0, count=0;
    
    cart.forEach((item,idx)=>{
      subtotal += item.unitPrice*item.qty;
      count += item.qty;
      // ... (rest of the cart item list rendering)
      const li = document.createElement('li');
      li.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff9f5;border:1px solid #fee6d8';
      li.innerHTML = `
        <div style="flex:1;">
          <strong>${item.name}</strong> 
          <div style="font-size:12px;color:#666">${item.qty} Ã— RM ${item.unitPrice.toFixed(2)} = RM ${(item.unitPrice*item.qty).toFixed(2)}</div>
        </div>
        <div>
          <button onclick="changeCartQty(${idx},-1)" style="margin-left:6px;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;background:#e9ecef">âˆ’</button>
          <span style="font-weight:700;"> ${item.qty} </span>
          <button onclick="changeCartQty(${idx},1)" style="margin-left:6px;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;background:#e9ecef">+</button>
        </div>
        <button onclick="removeItem(${idx})" style="margin-left:10px;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;background:#ffdddd;color:#cc0000;">âœ•</button>
      `;
      list.appendChild(li);
    });

    totalEl.textContent = `Jumlah: RM ${subtotal.toFixed(2)}`;
    badge.textContent = count > 99 ? '99+' : count;
    document.getElementById('open-checkout').disabled = cart.length === 0;
  }

  function changeCartQty(index, change){
    cart[index].qty += change;
    if(cart[index].qty <= 0){
      removeItem(index);
    } else {
      saveCart();
      updateCartUI();
    }
  }

  function removeItem(index){
    cart.splice(index, 1);
    saveCart();
    updateCartUI();
    document.getElementById('checkout-form').classList.add('hidden');
  }

  function toggleCart(){
    document.getElementById('cart-panel').classList.toggle('show');
  }

  function showCheckoutForm(){
    if(cart.length === 0) {
      alert('Troli anda kosong.');
      return;
    }
    document.getElementById('checkout-form').classList.remove('hidden');
  }


  // ===== INIT (Runs on page load) =====
  document.addEventListener('DOMContentLoaded', ()=>{
    // Check if the user is already logged in (optional check)
    // For simplicity, we keep the login overlay active until manual login attempt.
  });
  
</script>
  
</body>
</html>
