<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Reseller Checkout â€” PipahCookies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F8FAFC; padding-bottom: 40px; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    .tier-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }
    .tier-1 { background: #e2e8f0; color: #64748b; } 
    .tier-2 { background: #dbeafe; color: #2563eb; } 
    .tier-3 { background: #dcfce7; color: #16a34a; } 
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 py-3 flex items-center justify-between shadow-sm">
    <div class="flex items-center gap-3">
        <a href="index.html" class="w-8 h-8 rounded-full bg-slate-100 grid place-items-center text-slate-600 hover:bg-slate-200 transition"><i class="fa-solid fa-arrow-left"></i></a>
        <h1 class="font-bold text-lg text-slate-800" data-i18n="title">Checkout Stok</h1>
    </div>
    <div class="flex bg-slate-100 p-1 rounded-lg">
        <button onclick="setLang('ms')" id="btn-ms" class="px-3 py-1 rounded-md text-xs font-bold transition bg-white shadow-sm text-slate-800">MY</button>
        <button onclick="setLang('en')" id="btn-en" class="px-3 py-1 rounded-md text-xs font-bold text-slate-400 hover:text-slate-600 transition">EN</button>
    </div>
  </div>

  <div class="max-w-2xl mx-auto px-4 mt-6 space-y-6">
    
    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2" data-i18n="cart_title">Senarai Barang</h2>
        <div id="cart-items" class="space-y-4">
            <div class="text-center py-8"><div class="loader mx-auto"></div></div>
        </div>
        <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between items-center">
            <span class="font-bold text-slate-500" data-i18n="total">Jumlah Besar</span>
            <span class="text-2xl font-extrabold text-blue-600" id="grand-total">RM 0.00</span>
        </div>
    </div>

    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2" data-i18n="details_title">Butiran Reseller</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lbl_name">Nama Penuh</label>
                <input type="text" id="r_name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold text-slate-800 outline-none focus:ring-2 ring-blue-500 transition">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lbl_date">Tarikh Pickup</label>
                    <input type="date" id="r_date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold text-slate-800 outline-none focus:ring-2 ring-blue-500 transition">
                </div>
                <div>
                     <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lbl_oid">No. Order</label>
                     <input type="text" id="r_oid" readonly class="w-full bg-slate-100 border border-slate-200 rounded-xl p-3 font-mono text-xs text-slate-500 cursor-not-allowed">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1" data-i18n="lbl_note">Nota Tambahan</label>
                <textarea id="r_note" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-medium outline-none focus:ring-2 ring-blue-500 transition"></textarea>
            </div>
        </div>
    </div>

    <div class="space-y-3 pb-8">
        <button id="btn-submit" onclick="submitOrder()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 transition active:scale-[0.98]">
            <i class="fa-brands fa-whatsapp text-xl"></i>
            <span data-i18n="btn_submit">Hantar Order</span>
        </button>
        
        <button onclick="downloadTxt()" class="w-full bg-white border border-slate-200 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-50 transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-file-lines"></i> <span data-i18n="btn_receipt">Simpan Resit (TXT)</span>
        </button>
    </div>

  </div>

  <script>
    // YOUR NEW CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyB1zNzsKmXXLVsOVGnVeGwlT_0uX3XqdO0",
      authDomain: "pipahcookies-order.firebaseapp.com",
      databaseURL: "https://pipahcookies-order-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "pipahcookies-order",
      storageBucket: "pipahcookies-order.firebasestorage.app",
      messagingSenderId: "1038900448087",
      appId: "1:1038900448087:web:a46586f21e9ae989708c12"
    };

    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const HQ_WHATSAPP = "60182806839"; 
    const CART_KEY = 'pipah_reseller_cart_v1';
    let CART = [], PRODUCTS_MAP = {};
    let curLang = 'ms';

    const i18n = {
        ms: {
            title: "Checkout Stok", cart_title: "Senarai Barang", total: "Jumlah Besar", details_title: "Butiran Reseller",
            lbl_name: "Nama Penuh", lbl_date: "Tarikh Pickup", lbl_oid: "No. Order", lbl_note: "Nota Tambahan (Optional)",
            btn_submit: "Hantar Order (WhatsApp)", btn_receipt: "Simpan Resit (TXT)",
            empty_cart: "Cart kosong", empty_sub: "Tiada barang dipilih", add_stock: "Tambah Stok +",
            alert_name: "Sila isi Nama Penuh anda.", alert_cart: "Cart kosong.", alert_err: "Ralat sambungan.",
            tier_1: "Harga Runcit", tier_2: "Harga Ejen", tier_3: "Harga Borong"
        },
        en: {
            title: "Stock Checkout", cart_title: "Item List", total: "Grand Total", details_title: "Reseller Details",
            lbl_name: "Full Name", lbl_date: "Pickup Date", lbl_oid: "Order ID", lbl_note: "Extra Note (Optional)",
            btn_submit: "Submit Order (WhatsApp)", btn_receipt: "Save Receipt (TXT)",
            empty_cart: "Cart is empty", empty_sub: "No items selected", add_stock: "Add Stock +",
            alert_name: "Please enter your Full Name.", alert_cart: "Cart is empty.", alert_err: "Connection error.",
            tier_1: "Retail Price", tier_2: "Agent Price", tier_3: "Bulk Price"
        }
    };

    async function init() {
        generateOrderId();
        const raw = localStorage.getItem(CART_KEY);
        if(raw) CART = JSON.parse(raw);

        try {
            const snap = await db.collection('products').get();
            snap.forEach(doc => PRODUCTS_MAP[doc.id] = doc.data());
            renderCart();
        } catch(e) { console.error(e); alert("Connection error. Check internet."); }
    }

    function generateOrderId() {
        const date = new Date();
        const str = date.getFullYear().toString().substr(-2) + (date.getMonth()+1).toString().padStart(2,'0') + date.getDate().toString().padStart(2,'0');
        const rand = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('r_oid').value = `STK-${str}-${rand}`;
    }

    window.setLang = (lang) => {
        curLang = lang;
        document.getElementById('btn-ms').className = lang==='ms' ? "px-3 py-1 rounded-md text-xs font-bold transition bg-white shadow-sm text-slate-800" : "px-3 py-1 rounded-md text-xs font-bold text-slate-400 hover:text-slate-600 transition";
        document.getElementById('btn-en').className = lang==='en' ? "px-3 py-1 rounded-md text-xs font-bold transition bg-white shadow-sm text-slate-800" : "px-3 py-1 rounded-md text-xs font-bold text-slate-400 hover:text-slate-600 transition";
        document.querySelectorAll('[data-i18n]').forEach(e => { if(i18n[lang][e.dataset.i18n]) e.innerText = i18n[lang][e.dataset.i18n]; });
        document.getElementById('r_name').placeholder = lang==='ms' ? "Nama anda" : "Your name";
        document.getElementById('r_note').placeholder = lang==='ms' ? "Contoh: Pickup pukul 3..." : "E.g. Pickup at 3pm...";
        renderCart();
    }

    function getPriceForQty(product, qty) {
        let finalPrice = product.priceTier1 || product.price || 0;
        let tierName = i18n[curLang].tier_1;
        let tierClass = "tier-1";

        const minQty2 = product.minQty2 || 99999;
        if (qty >= minQty2) {
            finalPrice = product.priceTier2 || finalPrice;
            tierName = i18n[curLang].tier_2;
            tierClass = "tier-2";
        }
        return { price: finalPrice, label: tierName, css: tierClass };
    }

    function renderCart() {
        const container = document.getElementById('cart-items');
        container.innerHTML = '';
        let total = 0;

        if(CART.length === 0) {
            container.innerHTML = `<div class="text-center py-8"><i class="fa-solid fa-basket-shopping text-4xl text-slate-200 mb-2"></i><p class="text-slate-400 font-bold">${i18n[curLang].empty_cart}</p><a href="index.html" class="text-blue-500 text-sm font-bold mt-2 inline-block">${i18n[curLang].add_stock}</a></div>`;
            document.getElementById('grand-total').innerText = "RM 0.00";
            document.getElementById('btn-submit').classList.add('opacity-50', 'pointer-events-none');
            return;
        }

        document.getElementById('btn-submit').classList.remove('opacity-50', 'pointer-events-none');

        CART.forEach(item => {
            const p = PRODUCTS_MAP[item.id] || { name: item.name }; // Fallback to item.name if map fails
            const name = p.name || "Product"; 
            const pricing = getPriceForQty(p, item.qty);
            const subtotal = pricing.price * item.qty;
            total += subtotal;

            container.innerHTML += `
            <div class="flex justify-between items-start border-b border-slate-50 last:border-0 pb-3 last:pb-0">
                <div class="flex items-start gap-3">
                    <div class="bg-blue-50 text-blue-600 w-10 h-10 rounded-lg grid place-items-center font-bold text-sm mt-0.5">${item.qty}x</div>
                    <div>
                        <h4 class="font-bold text-slate-700 text-sm leading-tight">${name}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs text-slate-400">@ RM ${pricing.price.toFixed(2)}</span>
                            <span class="tier-badge ${pricing.css}">${pricing.label}</span>
                        </div>
                    </div>
                </div>
                <span class="font-bold text-slate-800 mt-0.5">RM ${subtotal.toFixed(2)}</span>
            </div>`;
        });
        document.getElementById('grand-total').innerText = `RM ${total.toFixed(2)}`;
    }

    async function submitOrder() {
        const name = document.getElementById('r_name').value.trim();
        const date = document.getElementById('r_date').value;
        const oid = document.getElementById('r_oid').value;
        const note = document.getElementById('r_note').value;

        if(!name) return alert(i18n[curLang].alert_name);
        
        const btn = document.getElementById('btn-submit');
        const oldHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<div class="loader"></div>`;

        try {
            let grandTotal = 0;
            const itemsToSave = CART.map(c => {
                const p = PRODUCTS_MAP[c.id] || {name: c.name};
                const pricing = getPriceForQty(p, c.qty);
                grandTotal += pricing.price * c.qty;
                return { id: c.id, name: p.name, qty: c.qty, price: pricing.price, tier: pricing.label };
            });

            const batch = db.batch();
            const orderRef = db.collection('orders').doc(oid);
            batch.set(orderRef, {
                orderId: oid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                customerName: name, resellerName: name, type: 'restock', pickupDate: date, note: note,
                items: itemsToSave, totalPrice: grandTotal, status: 'new'
            });

            itemsToSave.forEach(i => {
                const prodRef = db.collection('products').doc(i.id);
                batch.update(prodRef, { soldCount: firebase.firestore.FieldValue.increment(i.qty) });
            });

            await batch.commit();

            let msg = `*RESTOCK ORDER: ${oid}* ðŸ“¦\nðŸ‘¤ ${name}\n`;
            if(date) msg += `ðŸ“… ${date}\n`;
            msg += `\n*ITEMS:*`;
            itemsToSave.forEach(i => { msg += `\nâ–ªï¸ ${i.qty}x ${i.name} (RM${i.price})`; });
            msg += `\n\n*TOTAL: RM ${grandTotal.toFixed(2)}*`;
            if(note) msg += `\nðŸ“ ${note}`;

            localStorage.removeItem(CART_KEY);
            window.location.href = `https://wa.me/${HQ_WHATSAPP}?text=${encodeURIComponent(msg)}`;

        } catch (error) {
            console.error(error);
            alert(i18n[curLang].alert_err);
            btn.disabled = false;
            btn.innerHTML = oldHtml;
        }
    }

    function downloadTxt() {
        const name = document.getElementById('r_name').value || "Reseller";
        const oid = document.getElementById('r_oid').value;
        let content = `PIPAH COOKIES - RESTOCK ORDER\n================================\n`;
        content += `Order ID: ${oid}\nName: ${name}\nDate: ${new Date().toLocaleString()}\n--------------------------------\n`;
        
        let total = 0;
        CART.forEach(c => {
            const p = PRODUCTS_MAP[c.id] || {name: c.name};
            const pricing = getPriceForQty(p, c.qty);
            const sub = pricing.price * c.qty;
            total += sub;
            content += `${c.qty}x ${p.name} @ RM${pricing.price} = RM${sub.toFixed(2)}\n`;
        });
        
        content += `--------------------------------\nTOTAL: RM ${total.toFixed(2)}\n================================\n`;
        const blob = new Blob([content], {type: "text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${oid}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    init();
  </script>
</body>
</html>
