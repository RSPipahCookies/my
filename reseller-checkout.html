<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Ringkasan Pesanan - PipahCookies</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #fff8f2;
      color: #4a3b2c;
      padding: 20px;
    }
    h1 {
      color: #a67734;
      text-align: center;
      margin-bottom: 10px;
    }
    .summary-box {
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .info p {
      margin: 4px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #fff1e6;
      color: #a67734;
    }
    tfoot td {
      font-weight: bold;
    }
    button {
      display: block;
      background: #a67734;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin: 20px auto 0;
      font-size: 15px;
    }
    button:hover {
      background: #d4b390;
    }
    .logo {
      display: block;
      margin: 0 auto 15px;
      width: 120px;
    }
  </style>
</head>
<body>

  <!-- Optional Logo -->
  <img src="images/Header2.jpg" alt="PipahCookies Logo" class="logo" onerror="this.style.display='none'">
  <h1>Ringkasan Pesanan</h1>

  <div class="summary-box">
    <div class="info">
      <p><strong>No. Pesanan:</strong> <span id="orderId"></span></p>
      <p><strong>Nama:</strong> <span id="customerName"></span></p>
      <p><strong>Alamat:</strong> <span id="customerAddress"></span></p>
      <p><strong>Tarikh:</strong> <span id="orderDate"></span></p>
    </div>

    <table id="orderTable">
      <thead>
        <tr><th>Produk</th><th>Kuantiti</th><th>Harga (RM)</th><th>Jumlah (RM)</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="3">Jumlah Keseluruhan</td><td id="totalCell">0.00</td></tr>
      </tfoot>
    </table>

    <button id="downloadPDF">Muat Turun PDF</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const order = JSON.parse(localStorage.getItem('pipah_reseller_order') || '{}');
    if (!order || !order.items) {
      alert('Tiada pesanan dijumpai.');
      return;
    }

    // üßÅ Display data
    document.getElementById('orderId').textContent = order.orderId || '-';
    document.getElementById('customerName').textContent = order.name || '-';
    document.getElementById('customerAddress').textContent = order.address || '-';
    document.getElementById('orderDate').textContent = new Date(order.date || Date.now()).toLocaleString();

    const tbody = document.querySelector('#orderTable tbody');
    let total = 0;
    order.items.forEach(item => {
      const subtotal = item.unitPrice * item.qty;
      total += subtotal;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>${item.unitPrice.toFixed(2)}</td>
        <td>${subtotal.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
    document.getElementById('totalCell').textContent = total.toFixed(2);

    // üç™ PDF Download
    document.getElementById('downloadPDF').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const logo = document.querySelector('.logo').src;

      // --- Header Section ---
      doc.setFillColor(245, 228, 195);
      doc.rect(0, 0, 210, 30, "F");
      doc.setFontSize(16);
      doc.setTextColor(70, 50, 30);
      doc.text("PipahCookies", 20, 18);
      doc.setFontSize(10);
      doc.text("Ringkasan Pesanan", 20, 25);

      // --- Logo if available ---
      if (logo && !logo.includes('data:')) {
        const img = new Image();
        img.src = logo;
        img.onload = () => {
          doc.addImage(img, "PNG", 160, 5, 35, 20);
          generatePDF();
        };
      } else {
        generatePDF();
      }

      function generatePDF() {
        let y = 40;
        doc.setFontSize(11);
        doc.setTextColor(60, 45, 30);
        doc.text(`No. Pesanan: ${order.orderId}`, 20, y);
        y += 7;
        doc.text(`Nama: ${order.name}`, 20, y);
        y += 7;
        doc.text(`Alamat: ${order.address || '-'}`, 20, y);
        y += 7;
        doc.text(`Tarikh: ${new Date(order.date || Date.now()).toLocaleString()}`, 20, y);

        // --- Table Section ---
        const tableData = order.items.map(item => [
          item.name,
          item.qty,
          item.unitPrice.toFixed(2),
          (item.qty * item.unitPrice).toFixed(2)
        ]);

        doc.autoTable({
          head: [['Produk', 'Kuantiti', 'Harga (RM)', 'Jumlah (RM)']],
          body: tableData,
          startY: y + 10,
          theme: 'grid',
          styles: { fontSize: 10, cellPadding: 3 },
          headStyles: { fillColor: [245, 228, 195], textColor: [70, 50, 30], halign: 'center' },
        });

        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12);
        doc.text(`Jumlah Keseluruhan: RM${total.toFixed(2)}`, 20, finalY);

        // --- Footer ---
        doc.setFontSize(9);
        doc.text("Terima kasih atas pesanan anda üíï", 20, finalY + 10);
        doc.text("PipahCookies - Rangup & Sedap, Setiap Gigitan Ada Senyuman üç™", 20, finalY + 15);

        doc.save(`Pesanan_${order.orderId}.pdf`);
      }
    });
  });
  </script>

</body>
</html>
