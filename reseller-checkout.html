<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ringkasan Pesanan — PipahCookies</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #A67734;
      --bg: #fff8f2;
      --card: #ffffff;
      --muted: #6b6b6b;
      --whatsapp: #25d366;
    }
    body {
      margin: 0;
      font-family: Poppins, Arial, sans-serif;
      background: var(--bg);
      color: #333;
      padding: 18px;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    h1 {
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 img { height: 36px; border-radius: 8px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    .controls {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn {
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.whatsapp { background: var(--whatsapp); color: #fff; }
    .btn.ghost { background: #eee; color: #333; }
    .btn.cancel { background: #888; color: #fff; }
    .btn.close { background: #ff5c5c; color: #fff; }
    input, textarea {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><img src="https://pipahcookies.github.io/com/images/logo.png"> Ringkasan Pesanan</h1>

    <label>No. Pesanan</label>
    <input type="text" id="orderId" readonly>

    <label>Nama Penuh</label>
    <input type="text" id="customerName" placeholder="Nama penuh">

    <label>Alamat (boleh kosong untuk pickup)</label>
    <textarea id="customerAddress" rows="2"></textarea>

    <table id="items-table">
      <thead>
        <tr><th>Produk</th><th>Unit (RM)</th><th>Qty</th><th>Subtotal (RM)</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3 id="total-display">Jumlah: RM 0.00</h3>

    <div class="controls">
      <button class="btn ghost" id="refresh">Refresh</button>
      <button class="btn primary" id="pdf">Download PDF</button>
      <button class="btn whatsapp" id="submit">Submit Order (WhatsApp)</button>
      <button class="btn cancel" id="back">Kembali ke Laman Utama</button>
      <button class="btn close" id="close">Tutup</button>
    </div>
  </div>

<script>
const CART_KEY = 'pipah_cart_v3';
const ORDER_KEY = 'pipah_reseller_order';
const WHATSAPP_NUMBER = '601121243407';

// 🧮 Number formatter
function formatRM(n){ return Number(n).toFixed(2); }

// 🧾 Generate new order ID
function nextOrderId(){
  let last = parseInt(localStorage.getItem('orderCounter')||'0');
  last++;
  localStorage.setItem('orderCounter', last);
  return 'PC' + String(last).padStart(5,'0');
}

// 📦 Load order/cart
function loadOrder(){
  const cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  let order = JSON.parse(localStorage.getItem(ORDER_KEY) || '{}');
  if(!order.items || order.items.length===0){
    order.items = cart;
  }
  if(!order.orderId) order.orderId = nextOrderId();
  localStorage.setItem(ORDER_KEY, JSON.stringify(order));
  return order;
}

// 🖋️ Render order
function render(){
  const order = loadOrder();
  document.getElementById('orderId').value = order.orderId;
  document.getElementById('customerName').value = order.name || '';
  document.getElementById('customerAddress').value = order.address || '';
  const tbody = document.querySelector('#items-table tbody');
  tbody.innerHTML = '';
  let total = 0;
  (order.items || []).forEach(it=>{
    const sub = it.unitPrice * it.qty;
    total += sub;
    tbody.innerHTML += `<tr>
      <td>${it.name}</td>
      <td>${formatRM(it.unitPrice)}</td>
      <td>${it.qty}</td>
      <td>${formatRM(sub)}</td>
    </tr>`;
  });
  document.getElementById('total-display').textContent = 'Jumlah: RM ' + formatRM(total);
}
render();

// 💾 Save form data
function saveForm(){
  const order = loadOrder();
  order.name = document.getElementById('customerName').value;
  order.address = document.getElementById('customerAddress').value;
  localStorage.setItem(ORDER_KEY, JSON.stringify(order));
  return order;
}

// 🔄 Refresh button
document.getElementById('refresh').addEventListener('click', render);

// 💬 WhatsApp submit
document.getElementById('submit').addEventListener('click', ()=>{
  const order = saveForm();
  if(!order.name){ alert('Sila isi nama penuh'); return; }

  let msg = `PipahCookies — Pesanan Baru%0A`;
  msg += `No. Pesanan: ${order.orderId}%0A`;
  msg += `Nama: ${order.name}%0A`;
  if(order.address) msg += `Alamat: ${order.address}%0A%0A`;
  msg += `Senarai Produk:%0A`;
  let total = 0;
  order.items.forEach(it=>{
    const sub = it.unitPrice * it.qty;
    total += sub;
    msg += `• ${it.name} (${it.qty} x RM${formatRM(it.unitPrice)}) = RM${formatRM(sub)}%0A`;
  });
  msg += `%0A🔸 Jumlah: RM${formatRM(total)}%0A`;
  msg += `%0ATerima kasih atas pesanan anda 💛`;

  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');

  // Move to next order ID after submit
  localStorage.removeItem(CART_KEY);
  localStorage.removeItem(ORDER_KEY);
  render();
});

// 🧾 PDF download
document.getElementById('pdf').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const order = saveForm();

  // beige background
  doc.setFillColor(255,248,242);
  doc.rect(0,0,210,297,"F");

  // logo
  const imgUrl = 'https://pipahcookies.github.io/com/images/logo.png';
  const img = await loadImage(imgUrl);
  doc.addImage(img, 'PNG', 20, 10, 25, 25);

  doc.setFontSize(16);
  doc.setTextColor(166,119,52);
  doc.text("PipahCookies - Ringkasan Pesanan", 50, 25);

  doc.setFontSize(12);
  doc.setTextColor(60,40,20);
  doc.text(`No. Pesanan: ${order.orderId}`, 20, 50);
  doc.text(`Nama: ${order.name}`, 20, 58);
  if(order.address) doc.text(`Alamat: ${order.address}`, 20, 66);

  let y = 80;
  doc.setFontSize(13);
  order.items.forEach(it=>{
    const sub = it.unitPrice * it.qty;
    doc.text(`${it.name} — ${it.qty} x RM${formatRM(it.unitPrice)} = RM${formatRM(sub)}`, 20, y);
    y += 8;
  });
  doc.text(`Jumlah: RM${formatRM(order.items.reduce((t,i)=>t+i.unitPrice*i.qty,0))}`, 20, y+8);

  doc.save(`${order.orderId}.pdf`);
});

function loadImage(url){
  return new Promise((resolve)=>{
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=>resolve(img);
    img.src = url;
  });
}

// 🔙 Back and Close
document.getElementById('back').addEventListener('click', ()=>{ window.location.href = 'index.html'; });
document.getElementById('close').addEventListener('click', ()=>{ window.close(); });
</script>
</body>
</html>
