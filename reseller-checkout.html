<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ringkasan Pesanan — PipahCookies</title>
  <style>
    :root{
      --primary:#A67734;
      --primary-dark:#d4b390;
      --bg:#fff8f2;
      --card:#ffffff;
      --muted:#6b6b6b;
      --whatsapp:#25d366;
    }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#222;padding:18px}
    .wrap{max-width:920px;margin:22px auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
    h1{font-family:Poppins, sans-serif;color:var(--primary-dark);margin:0 0 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #f1e6da;text-align:left;font-size:14px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap; margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.whatsapp{background:var(--whatsapp);color:#fff}
    .btn.ghost{background:transparent;border:2px solid #eee}
    input[type="text"], textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #eee}
    .totals{margin-top:12px;font-weight:800;font-size:16px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ringkasan Pesanan</h1>
    <p class="small">Semak pesanan anda — klik <strong>Submit Order</strong> untuk buka WhatsApp dengan mesej pesanan dan muat turun TXT automatik.</p>

    <div id="meta">
      <label>No. Pesanan</label>
      <div><input type="text" id="orderId" readonly style="background:#f6f2ee"></div>
      <label>Nama Penuh</label>
      <div><input type="text" id="customerName" placeholder="Nama penuh"></div>
      <label>Tarikh Pengambilan (Pickup)</label>
      <div><input type="text" id="pickupDate" readonly style="background:#f6f2ee; font-weight: bold;"></div>
      <label>Alamat (boleh kosong untuk pickup)</label>
      <div><textarea id="customerAddress" rows="2" placeholder="Alamat penuh (optional)"></textarea></div>
    </div>

    <div id="items-area">
      <table id="items-table">
        <thead>
          <tr><th>Produk</th><th>Unit</th><th>Qty</th><th>Subtotal (RM)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals" id="total-display">Jumlah: RM 0.00</div>

    <div class="controls">
      <button class="btn btn.ghost" id="download-csv">Muat Turun TXT</button>
      <button class="btn primary" id="refresh-from-storage">Refresh</button>
      <button class="btn whatsapp" id="submit-order">Submit Order (WhatsApp)</button>
    </div>

    <p class="small" style="margin-top:12px">
      Nota: Fail TXT akan dimuat turun automatik ke peranti anda. Aplikasi web tidak boleh melampirkan fail terus ke WhatsApp — selepas WhatsApp terbuka, sila lampirkan fail TXT jika perlu atau hantar mesej terus.
    </p>
  </div>

<script src="pipah-product-config.js"></script>

<script>
/**
 * reseller-checkout.html
 */

// FIXED: Use variables from config file
const WHATSAPP_NUMBER = window.ORDER_WHATSAPP_NUMBER || '60182806839'; 

// FIXED: Match the key used in index.html
const CART_KEY = 'pipah_reseller_cart_v1'; 
const ORDER_KEY = 'pipah_reseller_order';

function formatCurrency(n){ return Number(n).toFixed(2); }

function loadOrderFromStorage(){
  const raw = localStorage.getItem(ORDER_KEY);
  if(raw){
    try { return JSON.parse(raw); } catch(e){ console.error('invalid order json', e); }
  }
  // fallback construct from cart if pipah_reseller_order not present
  const cartRaw = localStorage.getItem(CART_KEY);
  const cart = cartRaw ? JSON.parse(cartRaw) : [];
  return {
    orderId: getNextOrderNumber(),
    name: '',
    address: '',
    // pickupDate will be undefined but will not break anything
    date: new Date().toISOString(),
    items: cart
  };
}

function renderOrder(){
  const order = loadOrderFromStorage();
  document.getElementById('orderId').value = order.orderId || getNextOrderNumber();
  document.getElementById('customerName').value = order.name || '';
  
  // Display Pickup Date
  const pickupDateEl = document.getElementById('pickupDate');
  if (order.pickupDate) {
      pickupDateEl.value = new Date(order.pickupDate).toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric' });
  } else {
      pickupDateEl.value = 'Belum ditetapkan';
  }

  document.getElementById('customerAddress').value = order.address || '';
  const tbody = document.querySelector('#items-table tbody');
  tbody.innerHTML = '';
  let total = 0;
  (order.items || []).forEach(it => {
    const tr = document.createElement('tr');

    // safely read values (fallbacks)
    const unitPrice = Number(it.unitPrice || it.price || 0);
    const qty = Number(it.qty || it.quantity || 0);
    const subtotal = unitPrice * qty;
    total += subtotal;

    tr.innerHTML = `<td>${escapeHtml(it.name || it.id || 'Produk')}</td>
                    <td>RM ${formatCurrency(unitPrice)}</td>
                    <td>${qty}</td>
                    <td>RM ${formatCurrency(subtotal)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('total-display').textContent = 'Jumlah: RM ' + formatCurrency(total);
}

function escapeHtml(text){ return String(text).replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

// Plain Text generator
function orderToText(order){
  const lines = [];

  lines.push('======================================');
  lines.push('  P I P A H C O O K I E S - O R D E R  ');
  lines.push('======================================');
  lines.push(`No. Pesanan: ${order.orderId || ''}`);
  lines.push(`Tarikh Dibuat: ${new Date(order.date).toLocaleString() || ''}`);
  lines.push(`Nama Penuh: ${order.name || '-'}`);
  lines.push(`Tarikh Pengambilan: ${order.pickupDate || 'Belum ditetapkan'}`);
  lines.push(`Alamat: ${order.address || 'Pickup/Tiada Alamat'}`);
  lines.push('--------------------------------------');
  
  lines.push('ITEM | HARGA UNIT | KUANTITI | SUBTOTAL');
  lines.push('--------------------------------------');
  let total = 0;
  (order.items || []).forEach(it=>{
    const unitPrice = Number(it.unitPrice||0);
    const qty = Number(it.qty||0);
    const sub = unitPrice * qty;
    total += sub;
    const line = `${(it.name || it.id).padEnd(25).slice(0, 25)} | RM ${unitPrice.toFixed(2).padEnd(6)} | ${String(qty).padEnd(8)} | RM ${sub.toFixed(2)}`;
    lines.push(line);
  });
  lines.push('--------------------------------------');
  
  lines.push(`TOTAL JUMLAH: RM ${formatCurrency(total)}`);
  lines.push('======================================');
  lines.push('Sila semak dan sahkan. Terima kasih!');
  
  return lines.join('\n');
}

// Trigger download 
function downloadText(filename, textContent){
  const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Open WhatsApp
function openWhatsApp(order){
  const lines = [];
  lines.push(`PipahCookies — Pesanan Baru`);
  lines.push(`No. Pesanan: ${order.orderId}`);
  lines.push(`Nama: ${order.name || '-'}`);
  if(order.pickupDate) lines.push(`Tarikh Pengambilan: ${new Date(order.pickupDate).toLocaleDateString('ms-MY', { year: 'numeric', month: 'long', day: 'numeric' })}`);
  if(order.address) lines.push(`Alamat: ${order.address}`);
  lines.push('');
  lines.push('Items:');
  let total = 0;
  (order.items || []).forEach(it => {
    const sub = (it.unitPrice||0) * (it.qty||0);
    total += sub;
    lines.push(`- ${it.name}  | ${it.qty} x RM ${formatCurrency(it.unitPrice)} = RM ${formatCurrency(sub)}`);
  });
  lines.push('');
  lines.push(`Jumlah: RM ${formatCurrency(total)}`);
  lines.push('');
  lines.push('Sila semak dan sahkan. Terima kasih!');

  const text = encodeURIComponent(lines.join('\n'));
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
  window.open(url, '_blank');
}

function getNextOrderNumber(){ let last = parseInt(localStorage.getItem('orderCounter')||'0',10); return formatOrderId(last+1); }
function formatOrderId(num){ return 'PC' + String(num).padStart(8,'0'); }
function incrementOrderCounter(){ let last = parseInt(localStorage.getItem('orderCounter')||'0',10); localStorage.setItem('orderCounter', String(last+1)); }

function gatherOrderFromForm(){
  const base = loadOrderFromStorage();
  const order = {
    orderId: document.getElementById('orderId').value || base.orderId || getNextOrderNumber(),
    date: base.date || new Date().toISOString(),
    name: document.getElementById('customerName').value.trim(),
    address: document.getElementById('customerAddress').value.trim(),
    pickupDate: base.pickupDate, 
    items: base.items || []
  };
  return order;
}

// handlers
document.getElementById('refresh-from-storage').addEventListener('click', ()=>{
  renderOrder();
});

document.getElementById('download-csv').addEventListener('click', ()=>{
  const order = gatherOrderFromForm();
  const text = orderToText(order);
  const fn = `${order.orderId || 'order'}_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
  downloadText(fn, text);
});

document.getElementById('submit-order').addEventListener('click', ()=>{
  const order = gatherOrderFromForm();
  if(!order.name){ alert('Sila isi nama penuh sebelum hantar pesanan.'); return; }

  // 1) auto-download TXT
  const text = orderToText(order);
  const fn = `${order.orderId || 'order'}.txt`;
  downloadText(fn, text);

  // 2) open WhatsApp
  openWhatsApp(order);

  // 3) persist final order record
  localStorage.setItem('pipah_reseller_order', JSON.stringify(order));

  // 4) increment order counter
  incrementOrderCounter();

  // 5) clear the cart
  try { localStorage.removeItem(CART_KEY); } catch(e){}

  // 6) confirmation
  alert('Order prepared — WhatsApp opened in new tab and TXT file telah dimuat turun. Sila semak dan hantar mesej di WhatsApp.');
});

// Check if config loaded
document.addEventListener('DOMContentLoaded', () => {
    if (typeof window.ORDER_WHATSAPP_NUMBER === 'undefined') {
        alert("Warning: pipah-product-config.js not loaded properly.");
    }
    renderOrder();
});

</script>
</body>
</html>
