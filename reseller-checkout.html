<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ringkasan Pesanan â€” PipahCookies</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #A67734;
      --primary-dark: #d4b390;
      --bg: #fff8f2;
      --card: #ffffff;
      --muted: #6b6b6b;
      --whatsapp: #25d366;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
      background: var(--bg);
      color: #222;
      padding: 18px;
    }
    .wrap {
      max-width: 920px;
      margin: 22px auto;
      background: var(--card);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.06);
    }
    h1 {
      font-family: Poppins, sans-serif;
      color: var(--primary-dark);
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 img { height: 36px; vertical-align: middle; border-radius: 8px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #f1e6da;
      text-align: left;
      font-size: 14px;
    }
    .muted { color: var(--muted); }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 18px;
    }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.whatsapp { background: var(--whatsapp); color: #fff; }
    .btn.ghost { background: transparent; border: 2px solid #eee; }
    .btn.cancel { background: #b7b7b7; color: #fff; }
    .btn.close { background: #ff6464; color: #fff; }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    .totals { margin-top: 12px; font-weight: 800; font-size: 16px; }
    .small { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><img src="https://pipahcookies.github.io/com/images/logo.png" alt="PipahCookies"> Ringkasan Pesanan</h1>
    <p class="small">Semak pesanan anda â€” klik <strong>Download PDF</strong> untuk simpan invois atau <strong>Submit Order</strong> untuk buka WhatsApp.</p>

    <div id="meta">
      <label>No. Pesanan</label>
      <div><input type="text" id="orderId" readonly style="background:#f6f2ee"></div>
      <label>Nama Penuh</label>
      <div><input type="text" id="customerName" placeholder="Nama penuh"></div>
      <label>Alamat (boleh kosong untuk pickup)</label>
      <div><textarea id="customerAddress" rows="2" placeholder="Alamat penuh (optional)"></textarea></div>
    </div>

    <div id="items-area">
      <table id="items-table">
        <thead>
          <tr><th>Produk</th><th>Unit</th><th>Qty</th><th>Subtotal (RM)</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="totals" id="total-display">Jumlah: RM 0.00</div>

    <div class="controls">
      <button class="btn ghost" id="download-pdf">Download PDF</button>
      <button class="btn primary" id="refresh-from-storage">Refresh</button>
      <button class="btn whatsapp" id="submit-order">Submit Order (WhatsApp)</button>
      <button class="btn cancel" id="cancel-btn">Kembali ke Laman Utama</button>
      <button class="btn close" id="close-btn">Tutup Halaman</button>
    </div>

    <p class="small" style="margin-top:12px">
      Nota: PDF akan dimuat turun automatik ke peranti anda. Aplikasi web tidak boleh melampirkan fail terus ke WhatsApp â€” selepas WhatsApp terbuka, sila lampirkan PDF jika perlu atau hantar mesej terus.
    </p>
  </div>

<script>
const WHATSAPP_NUMBER = '601121243407';
const CART_KEY = 'pipah_cart_v3';
const ORDER_KEY = 'pipah_reseller_order';
function formatCurrency(n){ return Number(n).toFixed(2); }

function loadOrderFromStorage(){
  const raw = localStorage.getItem(ORDER_KEY);
  if(raw){ try { return JSON.parse(raw); } catch(e){ console.error('invalid order json', e); } }
  return { orderId: getNextOrderNumber(), name: '', address: '', date: new Date().toISOString(), items: [] };
}

function renderOrder(){
  const order = loadOrderFromStorage();
  document.getElementById('orderId').value = order.orderId || getNextOrderNumber();
  document.getElementById('customerName').value = order.name || '';
  document.getElementById('customerAddress').value = order.address || '';
  const tbody = document.querySelector('#items-table tbody');
  tbody.innerHTML = '';
  let total = 0;
  (order.items || []).forEach(it => {
    const sub = (it.unitPrice || 0) * (it.qty || 0);
    total += sub;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.name}</td><td>RM ${formatCurrency(it.unitPrice)}</td><td>${it.qty}</td><td>RM ${formatCurrency(sub)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('total-display').textContent = 'Jumlah: RM ' + formatCurrency(total);
}

function getNextOrderNumber(){ let last = parseInt(localStorage.getItem('orderCounter')||'0',10); return 'PC' + String(last+1).padStart(8,'0'); }
function incrementOrderCounter(){ let last = parseInt(localStorage.getItem('orderCounter')||'0',10); localStorage.setItem('orderCounter', String(last+1)); }

function gatherOrderFromForm(){
  const base = loadOrderFromStorage();
  return {
    orderId: document.getElementById('orderId').value || base.orderId,
    date: new Date().toISOString(),
    name: document.getElementById('customerName').value.trim(),
    address: document.getElementById('customerAddress').value.trim(),
    items: base.items
  };
}

// ðŸ“„ Generate beautiful beige PDF
document.getElementById('download-pdf').addEventListener('click', async ()=>{
  const order = gatherOrderFromForm();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFillColor(255, 248, 242);
  doc.rect(0, 0, 210, 297, "F"); // beige background
  const logo = "https://pipahcookies.github.io/com/images/logo.png";
  const img = await fetch(logo).then(r=>r.blob()).then(b=>new Promise(res=>{
    const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.readAsDataURL(b);
  }));
  doc.addImage(img, "PNG", 20, 10, 25, 25);
  doc.setFontSize(18);
  doc.setTextColor(166, 119, 52);
  doc.text("PipahCookies â€” Ringkasan Pesanan", 50, 25);
  doc.setTextColor(60, 40, 20);
  doc.setFontSize(12);
  doc.text(`No. Pesanan: ${order.orderId}`, 20, 45);
  doc.text(`Nama: ${order.name}`, 20, 52);
  if(order.address) doc.text(`Alamat: ${order.address}`, 20, 59);
  let y = 75, total = 0;
  doc.setFontSize(13);
  doc.text("Senarai Produk:", 20, 68);
  order.items.forEach(it=>{
    const sub = (it.unitPrice||0)*(it.qty||0);
    total += sub;
    doc.text(`${it.name}  |  ${it.qty} x RM${formatCurrency(it.unitPrice)} = RM${formatCurrency(sub)}`, 20, y);
    y += 8;
  });
  doc.setFontSize(14);
  doc.text(`Jumlah: RM ${formatCurrency(total)}`, 20, y+10);
  doc.save(`${order.orderId}.pdf`);
});

// ðŸ’¬ WhatsApp submit
document.getElementById('submit-order').addEventListener('click', ()=>{
  const order = gatherOrderFromForm();
  if(!order.name){ alert('Sila isi nama penuh sebelum hantar pesanan.'); return; }

  const lines = [
    `PipahCookies â€” Pesanan Baru`,
    `No. Pesanan: ${order.orderId}`,
    `Nama: ${order.name}`,
    order.address ? `Alamat: ${order.address}` : '',
    '',
    'Senarai Produk:'
  ];
  let total = 0;
  order.items.forEach(it=>{
    const sub = (it.unitPrice||0)*(it.qty||0);
    total += sub;
    lines.push(`- ${it.name} (${it.qty} x RM${formatCurrency(it.unitPrice)}) = RM${formatCurrency(sub)}`);
  });
  lines.push('');
  lines.push(`Jumlah: RM ${formatCurrency(total)}`);
  lines.push('');
  lines.push('Terima kasih atas pesanan anda ðŸ’›');
  const text = encodeURIComponent(lines.join('\n'));
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, '_blank');

  incrementOrderCounter();
  localStorage.removeItem(CART_KEY);
  localStorage.setItem(ORDER_KEY, JSON.stringify(order));
});

// ðŸ”„ Refresh
document.getElementById('refresh-from-storage').addEventListener('click', renderOrder);

// ðŸšª Cancel and Close buttons
document.getElementById('cancel-btn').addEventListener('click', ()=>{
  window.location.href = 'index.html'; // go back to main page
});
document.getElementById('close-btn').addEventListener('click', ()=>{
  window.close();
});

renderOrder();
</script>
</body>
</html>
